<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí™ MacroMixer v3.4.2 - Dr. Carlos Edition</title>
    <meta name="description" content="Rastreador profissional de calorias e macros - Dr. Carlos Edition">
    <meta name="theme-color" content="#06b6d4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MacroMixer">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a; /* Slate 900 - Darker base */
            color: #e2e8f0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            transition: background 0.3s ease, border 0.3s ease;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; transition: background 0.3s ease; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .progress-bar {
            transition: width 1s ease-in-out, height 1s ease-in-out;
        }
        
        .preset-btn {
            transition: all 0.3s ease;
        }
        .preset-btn:active {
            transform: scale(0.95);
        }

        /* LIGHT MODE */
        body.light-mode {
            background-color: #f1f5f9; /* Slate 100 */
            color: #1e293b; /* Slate 800 */
        }
        body.light-mode .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.6);
        }
        body.light-mode ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        body.light-mode ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }
        body.light-mode ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        body.light-mode nav {
            background-color: #ffffff !important;
            border-bottom-color: #e2e8f0 !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pb-10">

    <!-- Navbar -->
    <nav class="w-full bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-dna text-cyan-500 text-xl"></i>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">MacroMixer <span class="text-xs text-gray-500 font-normal ml-1">v3.4.2</span></h1>
            </div>
            <div id="auth-container" class="text-xs flex items-center gap-3">
                <button id="theme-toggle" class="text-slate-400 hover:text-white transition-colors" title="Alternar tema">
                    <i class="fa-solid fa-moon" id="theme-icon"></i>
                </button>
                <button id="btn-login" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors flex items-center gap-2">
                    <i class="fa-brands fa-google"></i> Entrar
                </button>
                <div id="user-status" class="hidden text-gray-400 flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" id="connection-dot"></div>
                    <span id="username-display">Online</span>
                    <button id="btn-logout" class="ml-2 text-slate-500 hover:text-white" title="Sair"><i class="fa-solid fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="w-full max-w-md px-4 mt-6 space-y-6">

        <!-- Goals / Presets Section (Collapsible) -->
        <section id="goals-section" class="glass-panel rounded-xl p-4 shadow-lg hidden border-l-4 border-cyan-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-microchip mr-2"></i>Calibragem Dr. Carlos</h2>
                <button id="close-goals-btn" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>

            <!-- Dr Carlos Presets -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="applyPreset('A')" class="preset-btn bg-gradient-to-br from-red-900 to-red-700 hover:from-red-800 hover:to-red-600 border border-red-500/30 rounded-lg p-3 text-left group">
                    <div class="text-xs text-red-300 uppercase font-bold tracking-widest mb-1">Pr√©-Set A</div>
                    <div class="text-white font-bold text-sm"><i class="fa-solid fa-fire mr-1"></i> MASSACRE</div>
                    <div class="text-[10px] text-red-200 mt-1">Perna/Costas (High Carb)</div>
                </button>
                <button onclick="applyPreset('B')" class="preset-btn bg-gradient-to-br from-blue-900 to-blue-700 hover:from-blue-800 hover:to-blue-600 border border-blue-500/30 rounded-lg p-3 text-left group">
                    <div class="text-xs text-blue-300 uppercase font-bold tracking-widest mb-1">Pr√©-Set B</div>
                    <div class="text-white font-bold text-sm"><i class="fa-solid fa-snowflake mr-1"></i> V√ÅCUO</div>
                    <div class="text-[10px] text-blue-200 mt-1">Ombro/Bra√ßo (Low Carb)</div>
                </button>
            </div>

            <form id="goals-form" class="space-y-4">
                <!-- User Profile -->
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Peso Corporal (kg)</label>
                    <input type="number" id="user-weight" step="0.1" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-cyan-500 outline-none font-mono" placeholder="Ex: 93.0">
                    <p class="text-[10px] text-gray-500 mt-1">Base para c√°lculo de 2.5g a 3.0g de prote√≠na.</p>
                </div>

                <!-- Custom Whey Config -->
                <div class="border-t border-slate-700/50 pt-3 mt-2 bg-slate-800/30 p-3 rounded-lg">
                    <label class="text-xs text-cyan-400 uppercase font-bold mb-2 block"><i class="fa-solid fa-flask mr-1"></i> Configura√ß√£o do Whey</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400">Tamanho da Dose (g)</label>
                            <input type="number" id="whey-dose" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs" placeholder="Ex: 30">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400">Prote√≠na na Dose (g)</label>
                            <input type="number" id="whey-prot" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs font-bold text-green-500" placeholder="Ex: 24">
                        </div>
                    </div>
                </div>

                <!-- Macros -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400">Calorias (kcal)</label>
                        <input type="number" id="goal-cals" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Prote√≠na (g)</label>
                        <input type="number" id="goal-prot" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-green-500 outline-none font-bold">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Carboidrato (g)</label>
                        <input type="number" id="goal-carb" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Gordura (g)</label>
                        <input type="number" id="goal-fat" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white focus:border-yellow-500 outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-3 rounded transition-all uppercase tracking-wider text-sm shadow-lg shadow-cyan-900/50">Salvar Calibragem</button>
                
                <!-- Clear Cache Button -->
                <button type="button" id="clear-cache-btn" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded transition-all uppercase tracking-wider text-xs mt-2">
                    <i class="fa-solid fa-trash-can mr-1"></i> Limpar Cache & Atualizar
                </button>
            </form>
        </section>

        <!-- Dashboard / Equalizer -->
        <section class="glass-panel rounded-xl p-5 shadow-xl relative overflow-hidden">
             <!-- Background Grid Effect -->
             <div class="absolute inset-0 opacity-5 pointer-events-none" style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 20px 20px;"></div>

            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div>
                    <h2 class="text-cyan-500 text-xs uppercase font-bold tracking-widest">Painel de Controle</h2>
                </div>
                <div class="flex items-center gap-3 text-[10px] z-10">
                    <span id="sync-status" class="text-green-500">
                        <i class="fa-solid fa-circle-check"></i> Salvo
                    </span>
                    <button id="edit-goals-btn" class="text-slate-500 hover:text-cyan-400 text-xs uppercase font-bold tracking-wider">
                        <i class="fa-solid fa-gear mr-1"></i> Setup
                    </button>
                </div>
            </div>

            <!-- Calories Main -->
            <div class="mb-6 text-center relative z-10">
                <div class="text-4xl font-black text-white mb-1 tracking-tighter"><span id="display-cals">0</span> <span class="text-lg text-slate-500 font-medium">/ <span id="target-cals">0</span></span></div>
                <div class="w-full bg-slate-900 rounded-full h-4 overflow-hidden border border-slate-800">
                    <div id="bar-cals" class="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 h-4 rounded-full progress-bar shadow-[0_0_15px_rgba(236,72,153,0.5)]" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs mt-2 text-slate-400 font-mono">
                    <span>CONSUMIDO</span>
                    <span id="saldo-cals">BUFFER: 0</span>
                </div>
            </div>

            <!-- Macros Grid -->
            <div class="grid grid-cols-3 gap-4 text-center relative z-10">
                <!-- Protein -->
                <div class="bg-slate-800/50 rounded-lg p-2 border border-green-900/30">
                    <div class="text-[10px] text-green-400 uppercase font-bold mb-2">Prote√≠na</div>
                    <div class="w-full bg-slate-900 rounded-full h-20 relative mx-auto w-3 overflow-hidden flex flex-col justify-end group border border-slate-800">
                        <div id="bar-prot" class="bg-green-500 w-full progress-bar shadow-[0_0_10px_rgba(34,197,94,0.4)]" style="height: 0%"></div>
                    </div>
                    <div class="text-sm font-bold mt-2 text-white"><span id="display-prot">0</span>g</div>
                    <div class="text-[10px] text-slate-500">/<span id="target-prot">0</span></div>
                </div>
                <!-- Carbs -->
                <div class="bg-slate-800/50 rounded-lg p-2 border border-blue-900/30">
                    <div class="text-[10px] text-blue-400 uppercase font-bold mb-2">Carbo</div>
                    <div class="w-full bg-slate-900 rounded-full h-20 relative mx-auto w-3 overflow-hidden flex flex-col justify-end group border border-slate-800">
                        <div id="bar-carb" class="bg-blue-500 w-full progress-bar shadow-[0_0_10px_rgba(59,130,246,0.4)]" style="height: 0%"></div>
                    </div>
                    <div class="text-sm font-bold mt-2 text-white"><span id="display-carb">0</span>g</div>
                    <div class="text-[10px] text-slate-500">/<span id="target-carb">0</span></div>
                </div>
                <!-- Fat -->
                <div class="bg-slate-800/50 rounded-lg p-2 border border-yellow-900/30">
                    <div class="text-[10px] text-yellow-400 uppercase font-bold mb-2">Gordura</div>
                    <div class="w-full bg-slate-900 rounded-full h-20 relative mx-auto w-3 overflow-hidden flex flex-col justify-end group border border-slate-800">
                        <div id="bar-fat" class="bg-yellow-500 w-full progress-bar shadow-[0_0_10px_rgba(234,179,8,0.4)]" style="height: 0%"></div>
                    </div>
                    <div class="text-sm font-bold mt-2 text-white"><span id="display-fat">0</span>g</div>
                    <div class="text-[10px] text-slate-500">/<span id="target-fat">0</span></div>
                </div>
            </div>
        </section>

        <!-- Input Section -->
        <section class="glass-panel rounded-xl p-4 shadow-lg">
            <h2 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-3">Registrar Refei√ß√£o</h2>
            <div class="relative">
                <textarea id="meal-input" rows="4" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all resize-none font-mono text-sm" placeholder="Digite aqui... Ex:&#10;5 colheres de arroz&#10;2 bifes medios&#10;3 ovos&#10;Whey 40g"></textarea>
                
                <!-- Autocomplete Dropdown -->
                <div id="autocomplete-dropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-2xl max-h-60 overflow-y-auto z-50">
                    <!-- Suggestions will be inserted here -->
                </div>
                
                <div class="absolute bottom-3 right-3">
                    <button id="btn-calculate" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white p-3 rounded-full shadow-lg transform hover:scale-105 transition-all w-12 h-12 flex items-center justify-center">
                        <i class="fa-solid fa-calculator"></i>
                    </button>
                </div>
            </div>
            <div class="flex flex-col gap-1 mt-2 ml-1">
                <p class="text-[10px] text-gray-500"><i class="fa-solid fa-circle-info mr-1 text-cyan-500"></i> Aceita gramas (preciso) ou colheres/conchas (aproximado).</p>
                <p class="text-[10px] text-gray-600 italic">Dica: Folhas < 300g? Nem registre (Fibra Fantasma).</p>
            </div>
        </section>

        <!-- Daily Log -->
        <section class="glass-panel rounded-xl p-4 shadow-lg pb-8">
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <button id="prev-day-btn" class="text-cyan-400 hover:text-cyan-300"><i class="fa-solid fa-chevron-left"></i></button>
                        <h2 id="current-date-display" class="text-gray-400 text-xs uppercase font-bold tracking-widest">Hoje</h2>
                        <button id="next-day-btn" class="text-cyan-400 hover:text-cyan-300"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <button id="share-day-btn" class="text-xs text-purple-400 hover:text-purple-300" title="Compartilhar dia"><i class="fa-solid fa-share-nodes"></i></button>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button id="copy-yesterday-btn" class="flex-1 min-w-[100px] bg-green-700/30 hover:bg-green-700/50 text-green-400 text-xs font-bold py-2 px-3 rounded transition-all border border-green-700/50" title="Copiar refei√ß√µes de ontem">
                        <i class="fa-solid fa-copy mr-1"></i>Copiar Ontem
                    </button>
                    <button id="view-history-btn" class="flex-1 min-w-[100px] bg-cyan-700/30 hover:bg-cyan-700/50 text-cyan-400 text-xs font-bold py-2 px-3 rounded transition-all border border-cyan-700/50">
                        <i class="fa-solid fa-calendar-days mr-1"></i>Hist√≥rico
                    </button>
                    <button id="reset-day-btn" class="flex-1 min-w-[100px] bg-red-700/30 hover:bg-red-700/50 text-red-400 text-xs font-bold py-2 px-3 rounded transition-all border border-red-700/50">
                        <i class="fa-solid fa-trash mr-1"></i>Zerar Dia
                    </button>
                </div>
            </div>
            
            <div id="logs-container" class="space-y-3">
                <div class="text-center text-gray-600 py-4 italic text-sm">Nenhuma refei√ß√£o registrada hoje.</div>
            </div>
        </section>

        <!-- Weekly History Section -->
        <section id="history-section" class="glass-panel rounded-xl p-4 shadow-lg hidden border-l-4 border-purple-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-chart-line mr-2"></i>Hist√≥rico Semanal</h2>
                <button id="close-history-btn" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <!-- Chart Container -->
            <div class="bg-slate-900 rounded-lg p-4 mb-4">
                <canvas id="weekly-chart" class="w-full" style="max-height: 250px;"></canvas>
            </div>
            
            <!-- Weekly Summary -->
            <div id="weekly-summary" class="space-y-2">
                <!-- Dynamic content -->
            </div>
            
            <!-- Export Options -->
            <div class="mt-4 pt-4 border-t border-slate-700">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-2">Exportar Dados</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button id="export-csv-btn" class="bg-green-700 hover:bg-green-600 text-white text-xs font-bold py-2 px-3 rounded transition-all">
                        <i class="fa-solid fa-file-csv mr-1"></i> CSV
                    </button>
                    <button id="export-json-btn" class="bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold py-2 px-3 rounded transition-all">
                        <i class="fa-solid fa-file-code mr-1"></i> JSON
                    </button>
                    <button id="export-image-btn" class="bg-purple-700 hover:bg-purple-600 text-white text-xs font-bold py-2 px-3 rounded transition-all">
                        <i class="fa-solid fa-image mr-1"></i> Imagem
                    </button>
                    <button id="export-pdf-btn" class="bg-red-700 hover:bg-red-600 text-white text-xs font-bold py-2 px-3 rounded transition-all">
                        <i class="fa-solid fa-file-pdf mr-1"></i> PDF
                    </button>
                </div>
            </div>
            
            <!-- Compare Days -->
            <div class="mt-4 pt-4 border-t border-slate-700">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-2">Comparar Dias</h3>
                <div class="flex gap-2">
                    <select id="compare-day-select" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-2 text-xs text-white">
                        <option value="">Selecione um dia...</option>
                    </select>
                    <button id="toggle-compare-btn" class="bg-cyan-700 hover:bg-cyan-600 text-white text-xs font-bold py-2 px-3 rounded transition-all whitespace-nowrap">
                        <i class="fa-solid fa-chart-line mr-1"></i> Comparar
                    </button>
                </div>
            </div>
        </section>

        <!-- Water Counter -->
        <section class="glass-panel rounded-xl p-4 shadow-lg border-l-4 border-blue-400">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-droplet text-blue-400 text-lg"></i>
                    <h2 class="text-sm font-bold text-white">Hidrata√ß√£o</h2>
                </div>
                <button id="reset-water-btn" class="text-xs text-slate-500 hover:text-white" title="Resetar">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
            
            <div class="text-center mb-3">
                <div class="text-3xl font-black text-white mb-1">
                    <span id="water-current">0</span><span class="text-lg text-slate-500">ml</span>
                </div>
                <div class="text-xs text-slate-400 flex items-center justify-center gap-2">
                    <span>Meta: <span id="water-goal">3000</span>ml</span>
                    <button id="edit-water-goal-btn" class="text-blue-400 hover:text-blue-300" title="Editar meta">
                        <i class="fa-solid fa-edit text-xs"></i>
                    </button>
                </div>
            </div>
            
            <div class="w-full bg-slate-900 rounded-full h-3 overflow-hidden border border-slate-800 mb-4">
                <div id="water-bar" class="bg-gradient-to-r from-blue-400 to-cyan-400 h-3 rounded-full transition-all duration-500 shadow-[0_0_10px_rgba(96,165,250,0.5)]" style="width: 0%"></div>
            </div>
            
            <div class="grid grid-cols-4 gap-2">
                <button id="water-btn-100" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2 rounded transition-all border border-slate-700">
                    +100ml
                </button>
                <button id="water-btn-250" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2 rounded transition-all border border-slate-700">
                    +250ml
                </button>
                <button id="water-btn-500" class="bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold py-2 rounded transition-all">
                    +500ml
                </button>
                <button id="water-btn-1000" class="bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold py-2 rounded transition-all">
                    +1L
                </button>
            </div>
            
            <div id="water-status" class="text-xs text-center mt-3 text-slate-400">
                <i class="fa-solid fa-info-circle mr-1"></i>Beba √°gua regularmente!
            </div>
        </section>

        <!-- Weight Tracker - REMOVIDO CONFORME SOLICITADO -->

        <!-- Favorite Meals / Templates -->
        <section class="glass-panel rounded-xl p-4 shadow-lg border-l-4 border-amber-500">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-star text-amber-400 text-lg"></i>
                    <h2 class="text-sm font-bold text-white">Refei√ß√µes Favoritas</h2>
                </div>
                <button id="add-favorite-btn" class="text-xs text-amber-400 hover:text-amber-300">
                    <i class="fa-solid fa-plus mr-1"></i>Salvar Atual
                </button>
            </div>
            
            <div id="favorites-container" class="space-y-2">
                <div class="text-center text-slate-500 text-xs py-4">
                    <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma refei√ß√£o favorita ainda
                </div>
            </div>
        </section>

        <!-- Photo Gallery -->
        <section class="glass-panel rounded-xl p-4 shadow-lg border-l-4 border-pink-500">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-images text-pink-400 text-lg"></i>
                    <h2 class="text-sm font-bold text-white">Galeria de Fotos</h2>
                </div>
                <button id="open-gallery-btn" class="text-xs text-pink-400 hover:text-pink-300">
                    <i class="fa-solid fa-expand mr-1"></i>Ver Todas
                </button>
            </div>
            
            <div id="gallery-preview" class="grid grid-cols-4 gap-2">
                <div class="text-center text-slate-500 text-xs py-4 col-span-4">
                    <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma foto ainda
                </div>
            </div>
        </section>

        <!-- Achievements/Badges -->
        <section class="glass-panel rounded-xl p-4 shadow-lg border-l-4 border-yellow-500">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-trophy text-yellow-400 text-lg"></i>
                    <h2 class="text-sm font-bold text-white">Conquistas</h2>
                </div>
                <div class="text-xs text-yellow-400 font-bold" id="achievement-count">0/12</div>
            </div>
            
            <div id="achievements-container" class="grid grid-cols-3 gap-3">
                <!-- Achievements will be rendered here -->
            </div>
        </section>

        <!-- Suggestion Box (Dynamic) -->
        <div id="suggestion-box" class="hidden bg-slate-800 border-l-4 border-cyan-500 p-4 rounded text-sm text-gray-300 shadow-lg">
            <div class="flex items-start gap-3">
                <i class="fa-solid fa-user-doctor text-cyan-400 text-lg mt-1"></i> 
                <div>
                    <span class="block text-xs text-cyan-500 font-bold uppercase mb-1">Dr. Carlos Bot</span>
                    <span id="suggestion-text">Analisando dados...</span>
                </div>
            </div>
        </div>

        <!-- Share Modal -->
        <div id="share-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-slate-800 rounded-xl w-full max-w-md border border-slate-700 shadow-2xl overflow-hidden transform transition-all">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 flex justify-between items-center">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-share-nodes"></i>Compartilhar Dia
                    </h3>
                    <button id="close-share-modal" class="text-white/80 hover:text-white">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="bg-slate-900 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-cyan-400" id="share-cals">0</div>
                        <div class="text-xs text-gray-400">kcal consumidas</div>
                        <div class="flex justify-around mt-3 text-sm">
                            <div>
                                <div class="font-bold text-green-400" id="share-prot">0g</div>
                                <div class="text-xs text-gray-500">Prote√≠na</div>
                            </div>
                            <div>
                                <div class="font-bold text-blue-400" id="share-carb">0g</div>
                                <div class="text-xs text-gray-500">Carbo</div>
                            </div>
                            <div>
                                <div class="font-bold text-yellow-400" id="share-fat">0g</div>
                                <div class="text-xs text-gray-500">Gordura</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="share-whatsapp" class="bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                            <i class="fa-brands fa-whatsapp text-xl"></i>WhatsApp
                        </button>
                        <button id="share-copy" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-copy"></i>Copiar
                        </button>
                    </div>
                    
                    <div class="text-xs text-center text-gray-500">
                        <i class="fa-solid fa-info-circle mr-1"></i>Compartilhe seu progresso!
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Modal -->
        <div id="gallery-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-slate-800 rounded-xl w-full max-w-4xl border border-slate-700 shadow-2xl overflow-hidden transform transition-all max-h-[90vh] flex flex-col">
                <div class="bg-gradient-to-r from-pink-600 to-purple-600 p-4 flex justify-between items-center">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-images"></i>Galeria de Fotos
                    </h3>
                    <button id="close-gallery-btn" class="text-white/80 hover:text-white">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div id="gallery-grid" class="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 overflow-y-auto">
                    <div class="text-center text-gray-500 text-sm py-8 col-span-full">
                        <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma foto ainda
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Permission Banner -->
        <div id="notification-banner" class="hidden fixed bottom-20 left-4 right-4 max-w-md mx-auto bg-gradient-to-r from-orange-600 to-red-600 text-white p-4 rounded-lg shadow-2xl z-40 animate-bounce">
            <div class="flex items-start gap-3">
                <i class="fa-solid fa-bell text-2xl"></i>
                <div class="flex-1">
                    <div class="font-bold mb-1">Ativar Notifica√ß√µes?</div>
                    <div class="text-xs opacity-90">Receba lembretes para n√£o esquecer suas refei√ß√µes!</div>
                    <div class="flex gap-2 mt-3">
                        <button id="enable-notifications" class="bg-white text-orange-600 px-4 py-1 rounded font-bold text-sm hover:bg-gray-100">
                            Ativar
                        </button>
                        <button id="dismiss-notifications" class="bg-orange-800 px-4 py-1 rounded text-sm hover:bg-orange-900">
                            Agora n√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <section id="notifications-section" class="glass-panel rounded-xl p-4 shadow-lg border-l-4 border-orange-500">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-sm font-bold text-white"><i class="fa-solid fa-bell mr-2"></i>Lembretes</h2>
                <button id="toggle-notifications-btn" class="text-xs text-orange-400 hover:text-orange-300">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
            
            <div id="notification-settings" class="hidden space-y-3">
                <div class="flex items-center justify-between bg-slate-800/50 p-2 rounded">
                    <span class="text-xs text-gray-300">Lembrete de Caf√© da Manh√£</span>
                    <div class="flex items-center gap-2">
                        <input type="time" id="breakfast-time" value="08:00" class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white">
                        <input type="checkbox" id="breakfast-enabled" class="w-4 h-4">
                    </div>
                </div>
                <div class="flex items-center justify-between bg-slate-800/50 p-2 rounded">
                    <span class="text-xs text-gray-300">Lembrete de Almo√ßo</span>
                    <div class="flex items-center gap-2">
                        <input type="time" id="lunch-time" value="12:00" class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white">
                        <input type="checkbox" id="lunch-enabled" class="w-4 h-4">
                    </div>
                </div>
                <div class="flex items-center justify-between bg-slate-800/50 p-2 rounded">
                    <span class="text-xs text-gray-300">Lembrete de Jantar</span>
                    <div class="flex items-center gap-2">
                        <input type="time" id="dinner-time" value="19:00" class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white">
                        <input type="checkbox" id="dinner-enabled" class="w-4 h-4">
                    </div>
                </div>
                <button id="save-notifications-btn" class="w-full bg-orange-700 hover:bg-orange-600 text-white text-xs font-bold py-2 rounded transition-all">
                    Salvar Lembretes
                </button>
            </div>
            
            <div id="notification-status" class="text-xs text-gray-400 text-center py-2">
                <i class="fa-solid fa-info-circle mr-1"></i>Configure seus lembretes para n√£o esquecer de comer!
            </div>
        </section>

    </main>

    <!-- Modal for Meal Details -->
    <div id="modal-result" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl w-full max-w-sm border border-slate-700 shadow-2xl overflow-hidden transform transition-all">
            <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-white"><i class="fa-solid fa-check-circle text-cyan-500 mr-2"></i>Confer√™ncia</h3>
                <button id="close-modal" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <!-- Warning Banner for Approximate Measures -->
            <div id="accuracy-warning" class="hidden bg-yellow-900/40 border-l-4 border-yellow-500 p-3 mx-4 mt-4">
                <div class="flex gap-2 text-yellow-200 text-xs">
                    <i class="fa-solid fa-triangle-exclamation mt-0.5"></i>
                    <div>
                        <span class="font-bold">C√°lculo Aproximado!</span>
                        <p class="opacity-80">Voc√™ usou colheres/pe√ßas. O erro pode ser de 20-30%. Use balan√ßa quando poss√≠vel.</p>
                    </div>
                </div>
            </div>

            <div class="p-4 max-h-[50vh] overflow-y-auto" id="modal-content">
                <!-- Dynamic Content -->
            </div>
            
            <!-- Photo Section -->
            <div class="px-4 pb-3">
                <div class="flex items-center gap-2 mb-2">
                    <label for="meal-photo-input" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2 px-3 rounded transition-all cursor-pointer text-center border border-slate-700">
                        <i class="fa-solid fa-image mr-2"></i>Galeria
                    </label>
                    <input type="file" id="meal-photo-input" accept="image/*" class="hidden" />
                    
                    <label for="meal-camera-input" class="flex-1 bg-cyan-700 hover:bg-cyan-600 text-white text-xs font-bold py-2 px-3 rounded transition-all cursor-pointer text-center border border-cyan-600">
                        <i class="fa-solid fa-camera mr-2"></i>C√¢mera
                    </label>
                    <input type="file" id="meal-camera-input" accept="image/*" capture="environment" class="hidden" />
                    
                    <button id="remove-photo-btn" class="hidden bg-red-700 hover:bg-red-600 text-white text-xs font-bold py-2 px-3 rounded transition-all">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <div id="photo-preview" class="hidden rounded overflow-hidden border border-slate-700">
                    <img id="photo-preview-img" class="w-full" />
                </div>
            </div>
            
            <div class="p-4 bg-slate-900 border-t border-slate-700">
                <button id="confirm-meal" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-cyan-900/50">
                    Lan√ßar na Dieta
                </button>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div id="gallery-modal" class="fixed inset-0 bg-black/95 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl w-full max-w-4xl border border-slate-700 shadow-2xl overflow-hidden transform transition-all max-h-[90vh] flex flex-col">
            <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-white"><i class="fa-solid fa-images text-pink-500 mr-2"></i>Galeria de Fotos</h3>
                <button id="close-gallery-btn" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div id="gallery-grid" class="p-4 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-3">
                <div class="text-center text-slate-500 text-sm py-8 col-span-full">
                    <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma foto encontrada
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- DATABASE DE ALIMENTOS v2.2 - DR. CARLOS EDITION (Calibrado) ---
        // Base calibrada para Bodybuilding Enhanced
        // Valores mistos: 100g + Unidades pr√°ticas
        const foodDatabase = {
    // ==================== CARBOIDRATOS ====================
    // Arroz e Cereais
    "arroz": { c: 28.1, p: 2.5, f: 0.2, kcal: 129, unit: "Arroz Branco (Cozido) - 100g", approx: { colher: 25, escumadeira: 80, xicara: 150 } },
    "arroz branco": { c: 28.1, p: 2.5, f: 0.2, kcal: 129, unit: "Arroz Branco (Cozido) - 100g", approx: { colher: 25, escumadeira: 80 } },
    "arroz integral": { c: 25.8, p: 2.6, f: 1.0, kcal: 123, unit: "Arroz Integral (Cozido) - 100g", approx: { colher: 25, escumadeira: 80 } },
    
    // Aveia
    "aveia": { c: 66.6, p: 13.9, f: 8.5, kcal: 394, unit: "Aveia em Flocos - 100g", approx: { colher: 15, xicara: 80 } },
    "aveia colher": { c: 10, p: 2.1, f: 1.3, kcal: 59, unit: "Aveia (1 Colher Sopa) - 15g", approx: { colher: 15 } },
    "1 colher aveia": { c: 10, p: 2.1, f: 1.3, kcal: 59, unit: "Aveia (1 Colher Sopa) - 15g", approx: { colher: 15 } },
    
    // Tub√©rculos
    "batata": { c: 20.1, p: 1.7, f: 0.1, kcal: 86, unit: "Batata Inglesa (Cozida) - 100g", approx: { colher: 30, unidade: 150 } },
    "batata inglesa": { c: 20.1, p: 1.7, f: 0.1, kcal: 86, unit: "Batata Inglesa (Cozida) - 100g", approx: { colher: 30, unidade: 150 } },
    "batata doce": { c: 23.9, p: 1.3, f: 0.3, kcal: 103, unit: "Batata Doce (Cozida) - 100g", approx: { colher: 30, unidade: 150, rodelas: 40 } },
    "mandioca": { c: 30.1, p: 0.6, f: 0.3, kcal: 125, unit: "Mandioca/Aipim (Cozida) - 100g", approx: { pedaco: 100, colher: 40 } },
    "aipim": { c: 30.1, p: 0.6, f: 0.3, kcal: 125, unit: "Mandioca/Aipim (Cozida) - 100g", approx: { pedaco: 100, colher: 40 } },
    
    // P√£es
    "pao": { c: 29, p: 4.5, f: 0.5, kcal: 135, unit: "P√£o Franc√™s (1 Unidade) - 50g", approx: { unidade: 50 } },
    "p√£o": { c: 29, p: 4.5, f: 0.5, kcal: 135, unit: "P√£o Franc√™s (1 Unidade) - 50g", approx: { unidade: 50 } },
    "pao frances": { c: 29, p: 4.5, f: 0.5, kcal: 135, unit: "P√£o Franc√™s (1 Unidade) - 50g", approx: { unidade: 50 } },
    "pao de forma": { c: 11, p: 2.1, f: 0.9, kcal: 62, unit: "P√£o de Forma (1 Fatia) - 25g", approx: { fatia: 25 } },
    "p√£o de forma": { c: 11, p: 2.1, f: 0.9, kcal: 62, unit: "P√£o de Forma (1 Fatia) - 25g", approx: { fatia: 25 } },
    "tapioca": { c: 60, p: 0, f: 0, kcal: 240, unit: "Tapioca (Goma Pronta) - 100g", approx: { colher: 20, crepe: 100 } },
    
    // Macarr√£o (mantendo da base antiga)
    "macarrao": { c: 30, p: 5, f: 1, kcal: 157, unit: "Macarr√£o (Cozido) - 100g", approx: { escumadeira: 90, pegador: 100, prato: 250 } },
    "macarr√£o": { c: 30, p: 5, f: 1, kcal: 157, unit: "Macarr√£o (Cozido) - 100g", approx: { escumadeira: 90, pegador: 100 } },
    
    // ==================== PROTE√çNAS ====================
    // Frango
    "frango": { c: 0, p: 32.0, f: 2.5, kcal: 159, unit: "Peito de Frango (Grelhado) - 100g", approx: { bife: 120, file: 120, pedaco: 100, colher: 30 } },
    "peito de frango": { c: 0, p: 32.0, f: 2.5, kcal: 159, unit: "Peito de Frango (Grelhado) - 100g", approx: { bife: 120, file: 120, pedaco: 100 } },
    "frango grelhado": { c: 0, p: 32.0, f: 2.5, kcal: 159, unit: "Peito de Frango (Grelhado) - 100g", approx: { bife: 120, file: 120 } },
    "frango desfiado": { c: 0, p: 31.0, f: 3.0, kcal: 151, unit: "Peito de Frango (Cozido/Desfiado) - 100g", approx: { colher: 30, xicara: 140 } },
    "frango cozido": { c: 0, p: 31.0, f: 3.0, kcal: 151, unit: "Peito de Frango (Cozido/Desfiado) - 100g", approx: { colher: 30, xicara: 140 } },
    
    // Carnes Bovinas
    "carne": { c: 0, p: 35.9, f: 7.3, kcal: 219, unit: "Patinho Mo√≠do (Refogado) - 100g", approx: { colher: 30, bife: 100, pedaco: 100 } },
    "patinho": { c: 0, p: 35.9, f: 7.3, kcal: 219, unit: "Patinho Mo√≠do (Refogado) - 100g", approx: { colher: 30, bife: 100 } },
    "carne moida": { c: 0, p: 35.9, f: 7.3, kcal: 219, unit: "Patinho Mo√≠do (Refogado) - 100g", approx: { colher: 30, bife: 100 } },
    "bife": { c: 0, p: 32, f: 11, kcal: 240, unit: "Bife Alcatra/Contra (Grelhado) - 100g", approx: { unidade: 120, medio: 120, grande: 180 } },
    "alcatra": { c: 0, p: 32, f: 11, kcal: 240, unit: "Bife Alcatra/Contra (Grelhado) - 100g", approx: { bife: 120, pedaco: 100 } },
    "contra file": { c: 0, p: 32, f: 11, kcal: 240, unit: "Bife Alcatra/Contra (Grelhado) - 100g", approx: { bife: 120, pedaco: 100 } },
    "fil√© mignon": { c: 0, p: 32, f: 8, kcal: 200, unit: "Fil√© Mignon (Grelhado) - 100g", approx: { bife: 120, medalhao: 80 } },
    "file mignon": { c: 0, p: 32, f: 8, kcal: 200, unit: "Fil√© Mignon (Grelhado) - 100g", approx: { bife: 120, medalhao: 80 } },
    "costela": { c: 0, p: 22.5, f: 32.0, kcal: 384, unit: "Costela Bovina (Assada/Churrasco) - 100g (S√≥ Carne)", approx: { pedaco: 100, porcao: 150 } },
    "costela bovina": { c: 0, p: 22.5, f: 32.0, kcal: 384, unit: "Costela Bovina (Assada/Churrasco) - 100g (S√≥ Carne)", approx: { pedaco: 100, porcao: 150 } },
    "costela assada": { c: 0, p: 22.5, f: 32.0, kcal: 384, unit: "Costela Bovina (Assada/Churrasco) - 100g (S√≥ Carne)", approx: { pedaco: 100, porcao: 150 } },
    
    // Peixes
    "tilapia": { c: 0, p: 24, f: 2.0, kcal: 115, unit: "Til√°pia (Grelhada) - 100g", approx: { file: 120, pedaco: 100 } },
    "til√°pia": { c: 0, p: 24, f: 2.0, kcal: 115, unit: "Til√°pia (Grelhada) - 100g", approx: { file: 120, pedaco: 100 } },
    "file de tilapia": { c: 0, p: 24, f: 2.0, kcal: 115, unit: "Til√°pia (Grelhada) - 100g", approx: { file: 120, pedaco: 100 } },
    "fil√© de til√°pia": { c: 0, p: 24, f: 2.0, kcal: 115, unit: "Til√°pia (Grelhada) - 100g", approx: { file: 120, pedaco: 100 } },
    "salmao": { c: 0, p: 24, f: 13, kcal: 220, unit: "Salm√£o (Grelhado) - 100g", approx: { file: 120, posta: 150, pedaco: 100 } },
    "salm√£o": { c: 0, p: 24, f: 13, kcal: 220, unit: "Salm√£o (Grelhado) - 100g", approx: { file: 120, posta: 150, pedaco: 100 } },
    "atum": { c: 0, p: 30, f: 1, kcal: 132, unit: "Atum (Conserva em √Ågua) - 100g", approx: { lata: 140, colher: 30 } },
    
    // Ovos - Completo
    "ovo": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Inteiro (1 Grande) - 50g", approx: { unidade: 50 } },
    "ovos": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Inteiro (1 Grande) - 50g", approx: { unidade: 50 } },
    "1 ovo": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Inteiro (1 Grande) - 50g", approx: { unidade: 50 } },
    "ovo grande": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Inteiro (1 Grande) - 50g", approx: { unidade: 50 } },
    "ovo cozido": { c: 0.6, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Cozido (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo cozinho": { c: 0.6, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Cozido (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo frito": { c: 0.5, p: 6.3, f: 7.0, kcal: 92, unit: "Ovo Frito com √ìleo (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo frito sem oleo": { c: 0.5, p: 6.3, f: 5.2, kcal: 75, unit: "Ovo Frito Sem √ìleo (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo frito sem √≥leo": { c: 0.5, p: 6.3, f: 5.2, kcal: 75, unit: "Ovo Frito Sem √ìleo (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo mexido": { c: 0.6, p: 6.5, f: 7.5, kcal: 95, unit: "Ovo Mexido com √ìleo (1 Unidade) - 55g", approx: { unidade: 55 } },
    "ovo mexido sem oleo": { c: 0.6, p: 6.5, f: 5.3, kcal: 78, unit: "Ovo Mexido Sem √ìleo (1 Unidade) - 55g", approx: { unidade: 55 } },
    "ovo mexido sem √≥leo": { c: 0.6, p: 6.5, f: 5.3, kcal: 78, unit: "Ovo Mexido Sem √ìleo (1 Unidade) - 55g", approx: { unidade: 55 } },
    "ovo poch√™": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Poch√™ (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo poche": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Poch√™ (1 Unidade) - 50g", approx: { unidade: 50 } },
    "ovo quente": { c: 0.4, p: 6.3, f: 5.0, kcal: 72, unit: "Ovo Quente (1 Unidade) - 50g", approx: { unidade: 50 } },
    "omelete": { c: 1.0, p: 7.0, f: 8.0, kcal: 105, unit: "Omelete Simples (1 Ovo) - 60g", approx: { unidade: 60 } },
    "clara": { c: 0.2, p: 3.6, f: 0, kcal: 17, unit: "Clara de Ovo (1 Unidade) - 35g", approx: { unidade: 35 } },
    "claras": { c: 1, p: 11, f: 0, kcal: 50, unit: "Clara Pasteurizada (L√≠quida) - 100g", approx: { xicara: 240, colher: 15 } },
    "clara liquida": { c: 1, p: 11, f: 0, kcal: 50, unit: "Clara Pasteurizada (L√≠quida) - 100g", approx: { xicara: 240 } },
    "clara pasteurizada": { c: 1, p: 11, f: 0, kcal: 50, unit: "Clara Pasteurizada (L√≠quida) - 100g", approx: { xicara: 240 } },
    "gema": { c: 0.6, p: 3, f: 5, kcal: 55, unit: "Gema de Ovo - 17g", approx: { unidade: 17 } },
    
    // Suplementos - CALIBRADO DR. CARLOS
    "whey": { c: 4.0, p: 17, f: 1.2, kcal: 120, unit: "Whey MK Concentrado 56% (1 Scoop) - 30g", approx: { scoop: 30, dose: 30, colher: 15 } },
    "whey mk": { c: 4.0, p: 17, f: 1.2, kcal: 120, unit: "Whey MK Concentrado 56% (1 Scoop) - 30g", approx: { scoop: 30, dose: 30 } },
    "whey concentrado": { c: 4.0, p: 17, f: 1.2, kcal: 120, unit: "Whey MK Concentrado 56% (1 Scoop) - 30g", approx: { scoop: 30, dose: 30 } },
    "whey padrao": { c: 2.5, p: 24, f: 1.0, kcal: 115, unit: "Whey Padr√£o 80% (1 Scoop) - 30g", approx: { scoop: 30, dose: 30 } },
    "whey isolado": { c: 2.5, p: 24, f: 1.0, kcal: 115, unit: "Whey Padr√£o 80% (1 Scoop) - 30g", approx: { scoop: 30, dose: 30 } },
    "1 scoop whey": { c: 4.0, p: 17, f: 1.2, kcal: 120, unit: "Whey MK Concentrado 56% (1 Scoop) - 30g", approx: { scoop: 30 } },
    "creatina": { c: 0, p: 0, f: 0, kcal: 0, unit: "Creatina - 5g", approx: { colher: 5 } },
    
    // Queijos (mantendo os mais usados)
    "queijo": { c: 2, p: 25, f: 30, kcal: 400, unit: "Queijo Mussarela - 100g", approx: { fatia: 20, pedaco: 30 } },
    "mussarela": { c: 2, p: 25, f: 30, kcal: 400, unit: "Queijo Mussarela - 100g", approx: { fatia: 20, pedaco: 30 } },
    "queijo cottage": { c: 3, p: 11, f: 4, kcal: 98, unit: "Queijo Cottage - 100g", approx: { colher: 30, pote: 200 } },
    "cottage": { c: 3, p: 11, f: 4, kcal: 98, unit: "Queijo Cottage - 100g", approx: { colher: 30, pote: 200 } },
    
    // Leite e Iogurte
    "leite": { c: 5, p: 3.2, f: 3.5, kcal: 61, unit: "Leite Integral - 100g", approx: { copo: 200, xicara: 240 } },
    "leite desnatado": { c: 5, p: 3.4, f: 0.2, kcal: 35, unit: "Leite Desnatado - 100g", approx: { copo: 200, xicara: 240 } },
    "iogurte": { c: 4, p: 3.5, f: 3, kcal: 61, unit: "Iogurte Natural - 100g", approx: { pote: 170, colher: 30 } },
    "iogurte grego": { c: 4, p: 9, f: 5, kcal: 97, unit: "Iogurte Grego - 100g", approx: { pote: 170, colher: 30 } },
    
    // ==================== LEGUMINOSAS ====================
    "feijao": { c: 13.6, p: 4.8, f: 0.5, kcal: 76, unit: "Feij√£o Carioca (Cozido/Caldo) - 100g", approx: { colher: 20, concha: 140 } },
    "feij√£o": { c: 13.6, p: 4.8, f: 0.5, kcal: 76, unit: "Feij√£o Carioca (Cozido/Caldo) - 100g", approx: { colher: 20, concha: 140 } },
    "feijao carioca": { c: 13.6, p: 4.8, f: 0.5, kcal: 76, unit: "Feij√£o Carioca (Cozido/Caldo) - 100g", approx: { colher: 20, concha: 140 } },
    "1 concha feijao": { c: 19, p: 6.7, f: 0.7, kcal: 106, unit: "Feij√£o (1 Concha) - 140g", approx: { concha: 140 } },
    "concha de feijao": { c: 19, p: 6.7, f: 0.7, kcal: 106, unit: "Feij√£o (1 Concha) - 140g", approx: { concha: 140 } },
    "feijao preto": { c: 14, p: 4.5, f: 0.5, kcal: 77, unit: "Feij√£o Preto (Cozido) - 100g", approx: { colher: 20, concha: 140 } },
    
    // ==================== FRUTAS ====================
    "maca": { c: 19.1, p: 0.3, f: 0.2, kcal: 72, unit: "Ma√ß√£ Fuji (1 M√©dia) - 130g", approx: { unidade: 130, media: 130 } },
    "ma√ß√£": { c: 19.1, p: 0.3, f: 0.2, kcal: 72, unit: "Ma√ß√£ Fuji (1 M√©dia) - 130g", approx: { unidade: 130, media: 130 } },
    "1 maca": { c: 19.1, p: 0.3, f: 0.2, kcal: 72, unit: "Ma√ß√£ Fuji (1 M√©dia) - 130g", approx: { unidade: 130 } },
    "maca 100g": { c: 14, p: 0.3, f: 0.2, kcal: 52, unit: "Ma√ß√£ - 100g", approx: { pedaco: 100 } },
    "banana": { c: 18, p: 0.9, f: 0.2, kcal: 68, unit: "Banana Prata (1 M√©dia) - 70g", approx: { unidade: 70, media: 70 } },
    "1 banana": { c: 18, p: 0.9, f: 0.2, kcal: 68, unit: "Banana Prata (1 M√©dia) - 70g", approx: { unidade: 70 } },
    "banana prata": { c: 18, p: 0.9, f: 0.2, kcal: 68, unit: "Banana Prata (1 M√©dia) - 70g", approx: { unidade: 70 } },
    "pessego": { c: 10, p: 0.9, f: 0.3, kcal: 39, unit: "P√™ssego (1 M√©dio) - 100g", approx: { unidade: 100 } },
    "p√™ssego": { c: 10, p: 0.9, f: 0.3, kcal: 39, unit: "P√™ssego (1 M√©dio) - 100g", approx: { unidade: 100 } },
    "1 pessego": { c: 10, p: 0.9, f: 0.3, kcal: 39, unit: "P√™ssego (1 M√©dio) - 100g", approx: { unidade: 100 } },
    "mamao": { c: 15, p: 0.8, f: 0.2, kcal: 60, unit: "Mam√£o Papaya (Meio) - 140g", approx: { fatia: 100, colher: 40, meio: 140 } },
    "mam√£o": { c: 15, p: 0.8, f: 0.2, kcal: 60, unit: "Mam√£o Papaya (Meio) - 140g", approx: { fatia: 100, colher: 40, meio: 140 } },
    "meio mamao": { c: 15, p: 0.8, f: 0.2, kcal: 60, unit: "Mam√£o Papaya (Meio) - 140g", approx: { meio: 140 } },
    
    // Outras frutas comuns (mantendo da base antiga)
    "morango": { c: 8, p: 0.7, f: 0.3, kcal: 32, unit: "Morango - 100g", approx: { unidade: 15, xicara: 150 } },
    "abacate": { c: 9, p: 2, f: 15, kcal: 160, unit: "Abacate - 100g", approx: { colher: 30, unidade: 200 } },
    "melancia": { c: 8, p: 0.6, f: 0.2, kcal: 30, unit: "Melancia - 100g", approx: { fatia: 200, pedaco: 100 } },
    "laranja": { c: 12, p: 0.9, f: 0.1, kcal: 47, unit: "Laranja - 100g", approx: { unidade: 130, media: 130 } },
    
    // ==================== GORDURAS ====================
    "azeite": { c: 0, p: 0, f: 13.5, kcal: 119, unit: "Azeite de Oliva (1 Colher Sopa) - 13ml", approx: { colher: 13, fio: 5 } },
    "1 colher azeite": { c: 0, p: 0, f: 13.5, kcal: 119, unit: "Azeite de Oliva (1 Colher Sopa) - 13ml", approx: { colher: 13 } },
    "azeite colher": { c: 0, p: 0, f: 13.5, kcal: 119, unit: "Azeite de Oliva (1 Colher Sopa) - 13ml", approx: { colher: 13 } },
    "manteiga": { c: 0, p: 0, f: 4.1, kcal: 37, unit: "Manteiga (Ponta de Faca) - 5g", approx: { ponta: 5, colher: 10 } },
    "ponta de faca manteiga": { c: 0, p: 0, f: 4.1, kcal: 37, unit: "Manteiga (Ponta de Faca) - 5g", approx: { ponta: 5 } },
    "pasta de amendoim": { c: 3, p: 4, f: 8, kcal: 90, unit: "Pasta de Amendoim (1 Colher) - 15g", approx: { colher: 15 } },
    "pasta amendoim": { c: 3, p: 4, f: 8, kcal: 90, unit: "Pasta de Amendoim (1 Colher) - 15g", approx: { colher: 15 } },
    "1 colher pasta amendoim": { c: 3, p: 4, f: 8, kcal: 90, unit: "Pasta de Amendoim (1 Colher) - 15g", approx: { colher: 15 } },
    
    // √ìleo (100g para c√°lculos)
    "oleo": { c: 0, p: 0, f: 100, kcal: 884, unit: "√ìleo de Cozinha - 100g", approx: { colher: 12, fio: 5 } },
    "√≥leo": { c: 0, p: 0, f: 100, kcal: 884, unit: "√ìleo de Cozinha - 100g", approx: { colher: 12, fio: 5 } },
    
    // ==================== VEGETAIS (Baixa Caloria - Mantendo alguns) ====================
    "brocolis": { c: 7, p: 2.8, f: 0.4, kcal: 34, unit: "Br√≥colis (Cozido) - 100g", approx: { ramo: 50, colher: 30 } },
    "br√≥colis": { c: 7, p: 2.8, f: 0.4, kcal: 34, unit: "Br√≥colis (Cozido) - 100g", approx: { ramo: 50, colher: 30 } },
    "couve": { c: 9, p: 4.3, f: 0.9, kcal: 49, unit: "Couve (Crua) - 100g", approx: { folha: 30, colher: 20 } },
    "alface": { c: 2.9, p: 1.4, f: 0.2, kcal: 15, unit: "Alface - 100g", approx: { folha: 20, prato: 50 } },
    "tomate": { c: 3.9, p: 0.9, f: 0.2, kcal: 18, unit: "Tomate - 100g", approx: { unidade: 100, rodela: 20 } },
    "cenoura": { c: 10, p: 0.9, f: 0.2, kcal: 41, unit: "Cenoura (Crua) - 100g", approx: { unidade: 80, rodela: 10 } },
    "abobrinha": { c: 3.1, p: 1.2, f: 0.3, kcal: 17, unit: "Abobrinha (Cozida) - 100g", approx: { unidade: 150, rodela: 20 } },
    
    // ==================== BEBIDAS ====================
    "cafe": { c: 0, p: 0.1, f: 0, kcal: 2, unit: "Caf√© (Sem A√ß√∫car) - 100g", approx: { xicara: 50, colher: 15 } },
    "caf√©": { c: 0, p: 0.1, f: 0, kcal: 2, unit: "Caf√© (Sem A√ß√∫car) - 100g", approx: { xicara: 50, colher: 15 } },
    "agua de coco": { c: 3.7, p: 0.7, f: 0.2, kcal: 19, unit: "√Ågua de Coco - 100g", approx: { copo: 200, caixinha: 330 } },
    "√°gua de coco": { c: 3.7, p: 0.7, f: 0.2, kcal: 19, unit: "√Ågua de Coco - 100g", approx: { copo: 200, caixinha: 330 } },
    "monster": { c: 2, p: 0, f: 0, kcal: 10, unit: "Monster Zero (Lata) - 100g", approx: { lata: 1, unidade: 1 } },
    "monster zero": { c: 2, p: 0, f: 0, kcal: 10, unit: "Monster Zero (Lata) - 100g", approx: { lata: 1, unidade: 1 } },
    "refrigerante zero": { c: 0, p: 0, f: 0, kcal: 0, unit: "Refrigerante Zero - 100g", approx: { copo: 200, lata: 350 } }
};


        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuLY3GI4pGLu6eRok77NyvaZsibi1g86U",
            authDomain: "macromixer-free.firebaseapp.com",
            projectId: "macromixer-free",
            storageBucket: "macromixer-free.firebasestorage.app",
            messagingSenderId: "398122075420",
            appId: "1:398122075420:web:592791231c9e14ffc166d9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = "macromixer-prod";
        
        // ==================== PERFORMANCE ====================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ==================== SEGURAN√áA ====================
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/[<>]/g, '').trim().substring(0, 1000); // Limita a 1000 chars
        }

        function validateNumber(value, min, max) {
            const num = parseFloat(value);
            if (isNaN(num) || num < min || num > max) return null;
            return num;
        }

        function validateWeight(weight) {
            return validateNumber(weight, 30, 300); // 30kg - 300kg
        }

        function validateCalories(cals) {
            return validateNumber(cals, 500, 10000); // 500 - 10000 kcal
        }

        function validateMacros(value) {
            return validateNumber(value, 0, 1000); // 0 - 1000g
        }

        // Vari√°veis globais
        let currentUser = null;
        let useLocalStorage = false;
        let userSettings = { cals: 2100, prot: 240, carb: 180, fat: 45, weight: 93, wheyDose: 30, wheyProt: 24 }; 
        let dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 }, water: 0 };
        let tempMealAnalysis = null;
        let currentViewDate = new Date();
        let weeklyChart = null;
        let notificationSettings = { breakfast: { time: '08:00', enabled: false }, lunch: { time: '12:00', enabled: false }, dinner: { time: '19:00', enabled: false } };
        let notificationIntervals = [];
        let waterGoal = 3000; // Meta padr√£o: 3L
        let isDarkMode = true; // Tema padr√£o: escuro
        let weightHistory = []; // Hist√≥rico de peso
        let weightChart = null; // Gr√°fico de peso
        let currentMealPhoto = null; // Foto tempor√°ria da refei√ß√£o
        let favoriteMeals = []; // Refei√ß√µes favoritas
        let macrosChart = null; // Gr√°fico de distribui√ß√£o de macros
        
        // Firebase listeners (para cancelar quando necess√°rio)
        let unsubscribeSettings = null;
        let unsubscribeLogs = null;

        // --- AUTH COM GOOGLE ---
        // Detecta se est√° em modo standalone (PWA instalado)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                            window.navigator.standalone || 
                            document.referrer.includes('android-app://');
        
        let isLoggingIn = false;
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 3;
        
        const handleLogin = async () => {
            // Prote√ß√£o contra loops infinitos
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                alert('‚ö†Ô∏è MUITAS TENTATIVAS DE LOGIN\n\nO login foi bloqueado temporariamente.\nRecarregue a p√°gina e tente novamente.\n\nüí° DICA: O app funciona 100% sem login!');
                return;
            }
            
            // Previne m√∫ltiplos cliques
            if (isLoggingIn) {
                console.log('‚ö†Ô∏è Login j√° em andamento, aguarde...');
                return;
            }
            
            // Se j√° estiver logado, n√£o faz nada
            if (currentUser) {
                console.log('‚úÖ Usu√°rio j√° est√° logado:', currentUser.displayName);
                return;
            }
            
            loginAttempts++;
            isLoggingIn = true;
            console.log(`üîµ Tentativa de login #${loginAttempts}/${MAX_LOGIN_ATTEMPTS}`);
            
            try {
                // SEMPRE usa popup (mais confi√°vel que redirect)
                console.log('Usando signInWithPopup...');
                const result = await signInWithPopup(auth, googleProvider);
                console.log('‚úÖ Login bem-sucedido!', result.user);
                isLoggingIn = false;
                loginAttempts = 0; // Reset contador
            } catch (error) {
                isLoggingIn = false;
                console.error('‚ùå Erro no login:', error);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    console.log('Usu√°rio fechou o popup');
                    loginAttempts--; // N√£o conta como tentativa falhada
                } else if (error.code === 'auth/popup-blocked') {
                    alert('‚ö†Ô∏è POPUP BLOQUEADO\n\nSeu navegador bloqueou o popup de login.\n\nüí° DICA: O app funciona 100% sem login!');
                } else {
                    alert(`‚ùå Erro ao fazer login: ${error.message}\n\nüí° DICA: O app funciona 100% sem login!`);
                }
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Erro no logout:', error);
            }
        };

        // SOLU√á√ÉO ALTERNATIVA: Desabilita getRedirectResult completamente
        // O app funcionar√° 100% offline com localStorage
        // Login com Firebase √© OPCIONAL e n√£o bloqueia o funcionamento
        console.log('üîµ Modo Offline Priorit√°rio Ativado');
        console.log('   Firebase √© opcional - app funciona sem login');

        // CARREGA DADOS DO LOCALSTORAGE ser√° feito no final (depois das fun√ß√µes serem definidas)
        console.log('üîµ Modo Offline Priorit√°rio Ativado');
        console.log('   Dados ser√£o carregados ap√≥s inicializa√ß√£o completa');
        
        // onAuthStateChanged ser√° configurado DEPOIS dos event listeners (no final do c√≥digo)

        function initAuth() {
            console.log('=== MacroMixer v3.4.2 - OFFLINE FIRST Edition ===');
            console.log('Firebase Auth:', auth);
            console.log('Verificando elementos...');
            console.log('btn-login existe?', document.getElementById('btn-login'));
            console.log('btn-logout existe?', document.getElementById('btn-logout'));
        }

        // --- PRESETS DR CARLOS ---
        window.applyPreset = (type) => {
            const presets = {
                'A': { cals: 2100, prot: 240, carb: 180, fat: 45 }, // Massacre
                'B': { cals: 1750, prot: 260, carb: 60, fat: 55 }  // Vacuo
            };
            
            const p = presets[type];
            document.getElementById('goal-cals').value = p.cals;
            document.getElementById('goal-prot').value = p.prot;
            document.getElementById('goal-carb').value = p.carb;
            document.getElementById('goal-fat').value = p.fat;
            
            alert(`Preset ${type === 'A' ? 'MASSACRE' : 'V√ÅCUO'} carregado. Clique em salvar.`);
        };

        // --- LOCAL STORAGE FUNCTIONS ---
        function saveToLocalStorage(key, data) {
            localStorage.setItem(`macromixer_${key}`, JSON.stringify(data));
        }

        function loadFromLocalStorage(key, defaultValue = null) {
            const data = localStorage.getItem(`macromixer_${key}`);
            return data ? JSON.parse(data) : defaultValue;
        }

        function loadUserSettingsLocal() {
            const saved = loadFromLocalStorage('settings');
            if (saved) {
                userSettings = { ...userSettings, ...saved };
                updateUIInputs();
                updateDashboard();
                document.getElementById('goals-section').classList.add('hidden');
            } else {
                document.getElementById('goals-section').classList.remove('hidden');
            }
        }

        function saveUserSettingsLocal(newSettings) {
            userSettings = newSettings;
            saveToLocalStorage('settings', newSettings);
            localStorage.setItem('macromixer_offline_mode', 'true');
            updateUIInputs();
            updateDashboard();
        }

        function loadDailyLogLocal() {
            const dateStr = currentViewDate.toISOString().split('T')[0];
            const saved = loadFromLocalStorage(`log_${dateStr}`);
            if (saved) {
                dailyLog = saved;
                if (!dailyLog.total) dailyLog.total = { cals: 0, prot: 0, carb: 0, fat: 0 };
                if (!dailyLog.water) dailyLog.water = 0;
                if (!dailyLog.items) dailyLog.items = [];
                
                let dataChanged = false;
                
                // Garante compatibilidade: adiciona campos cals/prot/carb/fat aos items antigos
                dailyLog.items = dailyLog.items.map(item => {
                    let newItem = { ...item };
                    let changed = false;
                    
                    if (newItem.cals === undefined && newItem.totals) {
                        newItem.cals = newItem.totals.kcal || 0;
                        changed = true;
                    }
                    if (newItem.prot === undefined && newItem.totals) {
                        newItem.prot = newItem.totals.p || 0;
                        changed = true;
                    }
                    if (newItem.carb === undefined && newItem.totals) {
                        newItem.carb = newItem.totals.c || 0;
                        changed = true;
                    }
                    if (newItem.fat === undefined && newItem.totals) {
                        newItem.fat = newItem.totals.f || 0;
                        changed = true;
                    }
                    
                    if (changed) dataChanged = true;
                    return newItem;
                });
                
                // Recalcula totais para garantir consist√™ncia
                recalculateTotals();
                
                // Se houve migra√ß√£o de dados, salva a vers√£o corrigida
                if (dataChanged) {
                    console.log('üíæ Salvando dados corrigidos/migrados...');
                    saveDailyLogLocal();
                }
            } else {
                dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 }, water: 0 };
            }
            renderLogs();
            updateDashboard();
            
            const today = new Date();
            if (currentViewDate.toDateString() === today.toDateString()) {
                analyzeContext();
            }
        }

        function saveDailyLogLocal() {
            const dateStr = currentViewDate.toISOString().split('T')[0];
            saveToLocalStorage(`log_${dateStr}`, dailyLog);
        }

        async function loadWeeklyDataLocal() {
            const weekData = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const saved = loadFromLocalStorage(`log_${dateStr}`);
                
                if (saved) {
                    weekData.push({
                        date: dateStr,
                        label: date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit' }),
                        total: saved.total || { cals: 0, prot: 0, carb: 0, fat: 0 }
                    });
                } else {
                    weekData.push({
                        date: dateStr,
                        label: date.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit' }),
                        total: { cals: 0, prot: 0, carb: 0, fat: 0 }
                    });
                }
            }
            
            return weekData;
        }

        function loadNotificationSettingsLocal() {
            const saved = loadFromLocalStorage('notifications');
            if (saved) {
                notificationSettings = saved;
                updateNotificationUI();
            }
        }

        function saveNotificationSettingsLocal(settings) {
            notificationSettings = settings;
            saveToLocalStorage('notifications', settings);
        }

        // --- DATABASE OPS ---
        function resetUIState() {
             userSettings = { cals: 2100, prot: 240, carb: 180, fat: 45, weight: 93, wheyDose: 30, wheyProt: 24 };
             dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 }, water: 0 };
             updateUIInputs();
             updateDashboard();
             renderLogs();
             if(unsubscribeSettings) unsubscribeSettings();
             if(unsubscribeLogs) unsubscribeLogs();
        }

        // Fun√ß√µes com Firebase
        async function loadUserSettings() {
            if (!currentUser) {
                console.log('‚ö†Ô∏è loadUserSettings: currentUser n√£o definido, usando localStorage');
                loadUserSettingsLocal();
                return;
            }
            
            const docRef = doc(db, 'users', currentUser.uid, 'settings', 'goals');
            console.log('üì• loadUserSettings: Carregando do Firebase');
            
            // Cancela listener anterior se existir
            if (unsubscribeSettings) {
                console.log('üîÑ Cancelando listener anterior de settings');
                unsubscribeSettings();
            }
            
            unsubscribeSettings = onSnapshot(docRef, (docSnap) => {
                console.log('üîî onSnapshot (settings) disparado');
                
                if (docSnap.exists()) {
                    console.log('‚úÖ Settings existem no Firebase');
                    const data = docSnap.data();
                    console.log('   Dados recebidos:', data);
                    
                    userSettings = { ...userSettings, ...data };
                    
                    // Salva no localStorage como backup
                    saveToLocalStorage('settings', userSettings);
                    
                    updateUIInputs();
                    updateDashboard();
                    document.getElementById('goals-section').classList.add('hidden');
                } else {
                    console.log('‚ÑπÔ∏è Settings n√£o existem, mostrando formul√°rio');
                    document.getElementById('goals-section').classList.remove('hidden');
                }
            }, (error) => {
                console.error('‚ùå Erro no onSnapshot (settings):', error);
                // Fallback para localStorage
                loadUserSettingsLocal();
            });
        }

        async function saveUserSettings(e) {
            e.preventDefault();
            if (!currentUser) return;

            // Valida√ß√£o de seguran√ßa
            const weight = validateWeight(document.getElementById('user-weight').value);
            const wheyDose = validateNumber(document.getElementById('whey-dose').value, 10, 100);
            const wheyProt = validateNumber(document.getElementById('whey-prot').value, 5, 50);
            const cals = validateCalories(document.getElementById('goal-cals').value);
            const prot = validateMacros(document.getElementById('goal-prot').value);
            const carb = validateMacros(document.getElementById('goal-carb').value);
            const fat = validateMacros(document.getElementById('goal-fat').value);

            if (!weight || !wheyDose || !wheyProt || !cals || !prot || !carb || !fat) {
                alert('‚ö†Ô∏è Valores inv√°lidos! Verifique os campos e tente novamente.');
                return;
            }

            const newSettings = {
                weight: weight,
                wheyDose: wheyDose,
                wheyProt: wheyProt,
                cals: cals,
                prot: prot,
                carb: carb,
                fat: fat
            };

            const docRef = doc(db, 'users', currentUser.uid, 'settings', 'goals');
            await setDoc(docRef, newSettings);
            
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "CALIBRADO!";
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-600');
                document.getElementById('goals-section').classList.add('hidden');
            }, 1000);
        }

        // Fun√ß√µes com Firebase
        async function loadDailyLog() {
            if (!currentUser) {
                console.log('‚ö†Ô∏è loadDailyLog: currentUser n√£o definido, usando localStorage');
                loadDailyLogLocal();
                return;
            }
            
            const todayStr = new Date().toISOString().split('T')[0];
            const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', todayStr);
            
            console.log('üì• loadDailyLog: Carregando do Firebase para', todayStr);

            // Cancela listener anterior se existir
            if (unsubscribeLogs) {
                console.log('üîÑ Cancelando listener anterior de logs');
                unsubscribeLogs();
            }

            unsubscribeLogs = onSnapshot(docRef, (docSnap) => {
                console.log('üîî onSnapshot (logs) disparado');
                
                if (docSnap.exists()) {
                    console.log('‚úÖ Documento existe no Firebase');
                    const data = docSnap.data();
                    console.log('   Dados recebidos:', data);
                    
                    dailyLog = data;
                    if (!dailyLog.total) dailyLog.total = { cals: 0, prot: 0, carb: 0, fat: 0 };
                    if (!dailyLog.water) dailyLog.water = 0;
                    if (!dailyLog.items) dailyLog.items = [];
                    
                    // Garante compatibilidade: adiciona campos cals/prot/carb/fat aos items antigos
                    dailyLog.items = dailyLog.items.map(item => {
                        if (!item.cals && item.totals) {
                            return {
                                ...item,
                                cals: item.totals.kcal || 0,
                                prot: item.totals.p || 0,
                                carb: item.totals.c || 0,
                                fat: item.totals.f || 0
                            };
                        }
                        return item;
                    });
                    
                    console.log('   Items ap√≥s migra√ß√£o:', dailyLog.items.length);
                    
                    // Recalcula totais para garantir consist√™ncia
                    recalculateTotals();
                    
                    // Salva no localStorage como backup
                    saveToLocalStorage(`log_${todayStr}`, dailyLog);
                } else {
                    console.log('‚ÑπÔ∏è Documento n√£o existe, criando novo');
                    dailyLog = { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 }, water: 0 };
                }
                
                console.log('üìä dailyLog.total ap√≥s load:', dailyLog.total);
                renderLogs();
                updateDashboard();
                updateWaterDisplay();
                analyzeContext();
            }, (error) => {
                console.error('‚ùå Erro no onSnapshot (logs):', error);
                // Fallback para localStorage
                loadDailyLogLocal();
            });
        }

        async function pushMealToDB() {
            if (!tempMealAnalysis) {
                alert('‚ö†Ô∏è Nenhuma refei√ß√£o calculada. Clique em "Calcular" primeiro.');
                return;
            }

            // Fun√ß√£o helper para garantir n√∫mero v√°lido
            const safeNumber = (val) => {
                const num = Number(val) || 0;
                return isNaN(num) || !isFinite(num) ? 0 : Math.round(num * 10) / 10;
            };

            const newTotal = {
                cals: safeNumber(dailyLog.total.cals + tempMealAnalysis.totals.kcal),
                prot: safeNumber(dailyLog.total.prot + tempMealAnalysis.totals.p),
                carb: safeNumber(dailyLog.total.carb + tempMealAnalysis.totals.c),
                fat: safeNumber(dailyLog.total.fat + tempMealAnalysis.totals.f)
            };

            // Limpa os foods para remover campos undefined ou complexos
            const cleanFoods = tempMealAnalysis.foods.map(food => ({
                name: String(food.name || "Desconhecido"),
                rawName: String(food.rawName || ""),
                qtd: safeNumber(food.qtd),
                unitDisplay: String(food.unitDisplay || "g"),
                macros: {
                    p: safeNumber(food.macros?.p),
                    c: safeNumber(food.macros?.c),
                    f: safeNumber(food.macros?.f),
                    kcal: safeNumber(food.macros?.kcal)
                },
                error: Boolean(food.error)
            }));

            const mealEntry = {
                name: String(tempMealAnalysis.mealName || "Refei√ß√£o"),
                timestamp: new Date().toISOString(),
                foods: cleanFoods,
                totals: {
                    p: safeNumber(tempMealAnalysis.totals.p),
                    c: safeNumber(tempMealAnalysis.totals.c),
                    f: safeNumber(tempMealAnalysis.totals.f),
                    kcal: safeNumber(tempMealAnalysis.totals.kcal)
                },
                // Campos para compatibilidade com recalculateTotals
                cals: safeNumber(tempMealAnalysis.totals.kcal),
                prot: safeNumber(tempMealAnalysis.totals.p),
                carb: safeNumber(tempMealAnalysis.totals.c),
                fat: safeNumber(tempMealAnalysis.totals.f),
                isApproximate: Boolean(tempMealAnalysis.isApproximate),
                photo: String(currentMealPhoto || "")
            };

            console.log('üì¶ Dados a serem salvos:', JSON.stringify(mealEntry, null, 2));

            // Atualiza dailyLog local
            dailyLog.items.push(mealEntry);
            dailyLog.total = newTotal;
            
            // SEMPRE salva no localStorage PRIMEIRO (prioridade)
            const todayStr = new Date().toISOString().split('T')[0];
            console.log('üíæ Salvando no localStorage (PRIORIDADE)...');
            saveToLocalStorage(`log_${todayStr}`, dailyLog);
            console.log('‚úÖ Salvo no localStorage com sucesso!');
            
            // Tenta sincronizar com Firebase (opcional, n√£o bloqueia)
            if (currentUser && !useLocalStorage) {
                try {
                    const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', todayStr);
                    console.log('üîÑ Sincronizando com Firebase (opcional)...');
                    
                    await setDoc(docRef, { 
                        items: dailyLog.items, 
                        total: newTotal,
                        water: dailyLog.water || 0
                    }, { merge: true });
                    
                    console.log('‚úÖ Sincronizado com Firebase!');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao sincronizar com Firebase (continuando offline):', error);
                    // N√£o mostra erro ao usu√°rio - app continua funcionando
                }
            } else {
                console.log('‚ÑπÔ∏è Firebase desabilitado - usando apenas localStorage');
            }
            
            // Atualiza UI
            console.log('üìä dailyLog.total ap√≥s salvar:', dailyLog.total);
            renderLogs();
            updateDashboard();
            analyzeContext();
            checkAchievements(); // Verifica conquistas
            
            document.getElementById('meal-input').value = "";
            document.getElementById('modal-result').classList.add('hidden');
            removePhoto(); // Limpa foto ap√≥s salvar
            
            console.log('‚úÖ Refei√ß√£o adicionada com sucesso!');
            console.log('üìä Estado final do dailyLog:', dailyLog);
        }
        
        async function resetDay() {
            if (!currentUser) return;
            if(!confirm("Limpar todo o hist√≥rico de hoje?")) return;
            
            const todayStr = new Date().toISOString().split('T')[0];
            const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', todayStr);
            await setDoc(docRef, { items: [], total: { cals: 0, prot: 0, carb: 0, fat: 0 }});
        }

        // --- NEW PARSER (DR CARLOS UNITS & WHEY CONFIG) ---

        function parseInput(text) {
            const lines = text.split('\n');
            const detectedFoods = [];
            let mealName = "Refei√ß√£o";
            let totals = { p:0, c:0, f:0, kcal:0 };
            let isApproximate = false;

            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                if (index === 0 && !/\d/.test(line)) {
                    mealName = line;
                    return;
                }
                
                let qtd = 0;
                let foodName = "";
                let unitUsed = "g";
                let matchedItem = null;
                let multiplier = 0;
                let wasApprox = false;

                const approxRegex = /(\d+)\s*(colheres?|conchas?|bifes?|fatias?|pedacos?|latas?|scoops?|unidades?|ovos?)/i;
                const gramRegex = /(\d+)\s*(g|ml)?/i;
                
                const approxMatch = line.match(approxRegex);
                const gramMatch = line.match(gramRegex);

                if (approxMatch) {
                    qtd = parseInt(approxMatch[1]);
                    let unitRaw = approxMatch[2].toLowerCase();
                    if(unitRaw.startsWith('colher')) unitUsed = 'colher';
                    else if(unitRaw.startsWith('concha')) unitUsed = 'concha';
                    else if(unitRaw.startsWith('bife')) unitUsed = 'bife';
                    else if(unitRaw.startsWith('fatia')) unitUsed = 'fatia';
                    else if(unitRaw.startsWith('pedaco')) unitUsed = 'pedaco';
                    else if(unitRaw.startsWith('lata')) unitUsed = 'lata';
                    else if(unitRaw.startsWith('scoop')) unitUsed = 'scoop';
                    else if(unitRaw.startsWith('ovo')) unitUsed = 'unidade';
                    else unitUsed = 'unidade';

                    foodName = line.replace(approxMatch[0], "").replace(" de ", " ").trim().toLowerCase();
                    
                    // Se foodName ficou vazio e a unidade √© "ovo/ovos", usar a unidade como foodName
                    if (!foodName && unitRaw.startsWith('ovo')) {
                        foodName = unitRaw;
                    }
                    
                    wasApprox = true;
                } else if (gramMatch) {
                    qtd = parseInt(gramMatch[1]);
                    unitUsed = 'g';
                    foodName = line.replace(gramMatch[0], "").replace(" de ", " ").trim().toLowerCase();
                } else {
                    foodName = line.toLowerCase();
                    qtd = 1; 
                }

                // DB Search
                let dbKeyMatched = "";
                for (const key in foodDatabase) {
                    if (foodName.includes(key)) {
                        if (!dbKeyMatched || key.length > dbKeyMatched.length) {
                            dbKeyMatched = key;
                            matchedItem = foodDatabase[key];
                        }
                    }
                }

                if (matchedItem) {
                    // --- WHEY PROTEIN SPECIAL LOGIC ---
                    if (dbKeyMatched.includes('whey')) {
                        // User Config com valida√ß√£o
                        let customDose = userSettings.wheyDose || 30;
                        let customProt = userSettings.wheyProt || 24;
                        
                        // Valida√ß√£o: evita divis√£o por zero
                        if (customDose <= 0) {
                            console.error("Dose de whey inv√°lida, usando padr√£o");
                            customDose = 30;
                            customProt = 24;
                        }
                        
                        const pRatio = customProt / customDose;
                        
                        // Approx Calories for Whey (Usually ~4kcal/g of protein + small leftover)
                        // Or we can scale database kcal/100g. 
                        // Database whey is ~400kcal/100g (standard powder). 
                        // Let's use database values for non-protein macros scaled by weight, but OVERRIDE protein.
                        
                        let weightInGrams = 0;
                        
                        if (wasApprox) {
                            isApproximate = true;
                            // Check if unit is scoop or colher
                            if(matchedItem.approx && matchedItem.approx[unitUsed]) {
                                weightInGrams = qtd * matchedItem.approx[unitUsed];
                                unitUsed = `${unitUsed} (~${weightInGrams}g)`;
                            } else {
                                weightInGrams = qtd * 30; // default scoop assumption
                                unitUsed = "scoop/dose est. (30g)";
                            }
                        } else {
                            // Direct grams (e.g. "40g whey")
                            weightInGrams = qtd;
                        }

                        // Calculate Macros based on custom protein config
                        const p = Math.round(weightInGrams * pRatio);
                        
                        // For C and F, assume standard ratios from DB (per 100g) scaled to weight
                        const c = Math.round((matchedItem.c / 100) * weightInGrams);
                        const f = Math.round((matchedItem.f / 100) * weightInGrams);
                        // Kcal = P*4 + C*4 + F*9 approx
                        const kcal = (p * 4) + (c * 4) + (f * 9);

                        totals.p += p; totals.c += c; totals.f += f; totals.kcal += kcal;

                        detectedFoods.push({
                            name: matchedItem.unit,
                            rawName: foodName,
                            qtd: qtd,
                            unitDisplay: unitUsed,
                            macros: { p, c, f, kcal }
                        });
                    } 
                    else {
                        // --- STANDARD LOGIC ---
                        if (wasApprox) {
                            isApproximate = true;
                            if (matchedItem.approx && matchedItem.approx[unitUsed]) {
                                const gramsPerUnit = matchedItem.approx[unitUsed];
                                const totalGrams = qtd * gramsPerUnit;
                                multiplier = totalGrams / 100;
                                unitUsed = `${unitUsed} (~${gramsPerUnit}g)`;
                            } else if (matchedItem.approx && matchedItem.approx['unidade']) {
                                const gramsPerUnit = matchedItem.approx['unidade'];
                                multiplier = (qtd * gramsPerUnit) / 100;
                                unitUsed = `unidade estim. (~${gramsPerUnit}g)`;
                            } else {
                                multiplier = (qtd * 50) / 100;
                                unitUsed = "unidade (estimado)";
                            }
                        } else {
                            // Gramas diretas - sempre dividir por 100 para normalizar
                            multiplier = qtd / 100;
                        }

                        const p = Math.round(matchedItem.p * multiplier);
                        const c = Math.round(matchedItem.c * multiplier);
                        const f = Math.round(matchedItem.f * multiplier);
                        const kcal = Math.round(matchedItem.kcal * multiplier);

                        totals.p += p; totals.c += c; totals.f += f; totals.kcal += kcal;

                        detectedFoods.push({
                            name: matchedItem.unit,
                            rawName: foodName,
                            qtd: qtd,
                            unitDisplay: unitUsed,
                            macros: { p, c, f, kcal }
                        });
                    }
                } else {
                     detectedFoods.push({
                        name: "Desconhecido (" + line + ")",
                        rawName: line,
                        qtd: 0,
                        unitDisplay: "?",
                        macros: { p:0, c:0, f:0, kcal:0 },
                        error: true
                    });
                }
            });

            return { mealName, foods: detectedFoods, totals, isApproximate };
        }

        function handleCalculate() {
            const text = sanitizeInput(document.getElementById('meal-input').value);
            if (!text.trim()) return;

            tempMealAnalysis = parseInput(text);
            
            const container = document.getElementById('modal-content');
            container.innerHTML = '';

            const warningEl = document.getElementById('accuracy-warning');
            if (tempMealAnalysis.isApproximate) warningEl.classList.remove('hidden');
            else warningEl.classList.add('hidden');

            const header = document.createElement('div');
            header.className = "bg-slate-900 rounded p-3 mb-4 text-center border border-slate-700";
            header.innerHTML = `
                <div class="text-xl font-bold text-white">${tempMealAnalysis.mealName}</div>
                <div class="flex justify-center gap-4 mt-2 text-sm">
                    <span class="text-purple-400 font-bold">${tempMealAnalysis.totals.kcal} kcal</span>
                    <span class="text-green-400 font-mono">P:${tempMealAnalysis.totals.p}</span>
                    <span class="text-blue-400 font-mono">C:${tempMealAnalysis.totals.c}</span>
                    <span class="text-yellow-400 font-mono">G:${tempMealAnalysis.totals.f}</span>
                </div>
            `;
            container.appendChild(header);

            tempMealAnalysis.foods.forEach(item => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center py-2 border-b border-slate-700 last:border-0";
                if (item.error) {
                    row.innerHTML = `<div class="text-red-400"><i class="fa-solid fa-triangle-exclamation mr-2"></i>${item.rawName} <span class="text-xs opacity-70">(N√£o encontrado)</span></div>`;
                } else {
                    row.innerHTML = `
                        <div>
                            <div class="text-gray-200 font-medium text-sm">${item.name}</div>
                            <div class="text-xs text-cyan-500">${item.qtd} ${item.unitDisplay}</div>
                        </div>
                        <div class="text-right text-xs text-gray-400 font-mono">
                            <div>${item.macros.kcal} kcal</div>
                            <div class="flex gap-1">
                                <span class="text-green-600">P:${item.macros.p}</span>
                                <span class="text-blue-600">C:${item.macros.c}</span>
                                <span class="text-yellow-600">G:${item.macros.f}</span>
                            </div>
                        </div>`;
                }
                container.appendChild(row);
            });
            document.getElementById('modal-result').classList.remove('hidden');
        }

        function updateUIInputs() {
            document.getElementById('user-weight').value = userSettings.weight;
            document.getElementById('whey-dose').value = userSettings.wheyDose;
            document.getElementById('whey-prot').value = userSettings.wheyProt;
            document.getElementById('goal-cals').value = userSettings.cals;
            document.getElementById('goal-prot').value = userSettings.prot;
            document.getElementById('goal-carb').value = userSettings.carb;
            document.getElementById('goal-fat').value = userSettings.fat;
            
            document.getElementById('target-cals').innerText = userSettings.cals;
            document.getElementById('target-prot').innerText = userSettings.prot;
            document.getElementById('target-carb').innerText = userSettings.carb;
            document.getElementById('target-fat').innerText = userSettings.fat;
        }

        const updateDashboard = throttle(function() {
            const t = dailyLog.total || { cals: 0, prot: 0, carb: 0, fat: 0 };
            const g = userSettings;
            
            console.log('üìä updateDashboard chamado:', t);
            
            document.getElementById('display-cals').innerText = t.cals || 0;
            document.getElementById('display-prot').innerText = t.prot || 0;
            document.getElementById('display-carb').innerText = t.carb || 0;
            document.getElementById('display-fat').innerText = t.fat || 0;

            const balance = g.cals - (t.cals || 0);
            document.getElementById('saldo-cals').innerText = `BUFFER: ${balance}`;
            
            setBar('bar-cals', t.cals || 0, g.cals);
            setBar('bar-prot', t.prot || 0, g.prot);
            setBar('bar-carb', t.carb || 0, g.carb);
            setBar('bar-fat', t.fat || 0, g.fat);
        }, 100); // Throttle de 100ms

        function setBar(id, val, max) {
            const pct = Math.min(100, Math.max(0, (val / max) * 100));
            const el = document.getElementById(id);
            if (id === 'bar-cals') el.style.width = `${pct}%`;
            else el.style.height = `${pct}%`;
            if (val > max) el.classList.add('bg-red-500'); else el.classList.remove('bg-red-500');
        }

        // ==================== CONTADOR DE √ÅGUA ====================
        function addWater(amount) {
            console.log('üö∞ addWater chamado:', amount);
            if (!dailyLog.water) dailyLog.water = 0;
            dailyLog.water += amount;
            console.log('üíß √Ågua total:', dailyLog.water);
            updateWaterDisplay();
            saveWaterToFirebase();
            checkAchievements(); // Verifica conquistas
        }

        function updateWaterDisplay() {
            const current = dailyLog.water || 0;
            const goal = waterGoal;
            const percentage = Math.min(100, (current / goal) * 100);
            
            document.getElementById('water-current').innerText = current;
            document.getElementById('water-goal').innerText = goal;
            document.getElementById('water-bar').style.width = percentage + '%';
            
            // Status message
            const statusEl = document.getElementById('water-status');
            if (percentage >= 100) {
                statusEl.innerHTML = '<i class="fa-solid fa-check-circle mr-1 text-green-400"></i><span class="text-green-400">Meta atingida! üéâ</span>';
            } else if (percentage >= 75) {
                statusEl.innerHTML = '<i class="fa-solid fa-thumbs-up mr-1 text-blue-400"></i><span class="text-blue-400">√ìtimo progresso!</span>';
            } else if (percentage >= 50) {
                statusEl.innerHTML = '<i class="fa-solid fa-droplet mr-1 text-cyan-400"></i><span class="text-cyan-400">Continue assim!</span>';
            } else if (percentage >= 25) {
                statusEl.innerHTML = '<i class="fa-solid fa-info-circle mr-1 text-yellow-400"></i><span class="text-yellow-400">Beba mais √°gua!</span>';
            } else {
                statusEl.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-1 text-orange-400"></i><span class="text-orange-400">Hidrate-se!</span>';
            }
        }

        async function saveWaterToFirebase() {
            console.log('üíæ saveWaterToFirebase chamado');
            console.log('üë§ currentUser:', currentUser ? currentUser.uid : 'null');
            console.log('üì¶ useLocalStorage:', useLocalStorage);
            console.log('üíß dailyLog.water:', dailyLog.water);
            
            if (!currentUser || useLocalStorage) {
                const todayStr = new Date().toISOString().split('T')[0];
                localStorage.setItem('macromixer_water_' + todayStr, dailyLog.water.toString());
                console.log('‚úÖ √Ågua salva no localStorage:', todayStr, dailyLog.water);
                return;
            }
            
            try {
                const todayStr = new Date().toISOString().split('T')[0];
                const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', todayStr);
                
                console.log('üî• Salvando no Firebase:', todayStr, dailyLog.water);
                // Usa setDoc com merge para criar ou atualizar
                await setDoc(docRef, { water: dailyLog.water }, { merge: true });
                console.log('‚úÖ √Ågua salva no Firebase com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar √°gua no Firebase:', error);
                // Fallback para localStorage se falhar
                const todayStr = new Date().toISOString().split('T')[0];
                localStorage.setItem('macromixer_water_' + todayStr, dailyLog.water.toString());
                console.log('‚úÖ √Ågua salva no localStorage (fallback):', todayStr, dailyLog.water);
            }
        }

        function editWaterGoal() {
            const newGoal = prompt('üíß Digite a nova meta de √°gua (em ml):', waterGoal);
            if (newGoal === null) return; // Cancelou
            
            const goalNum = parseInt(newGoal);
            if (isNaN(goalNum) || goalNum < 500 || goalNum > 10000) {
                alert('‚ö†Ô∏è Meta inv√°lida! Digite um valor entre 500ml e 10000ml.');
                return;
            }
            
            waterGoal = goalNum;
            localStorage.setItem('macromixer_water_goal', waterGoal.toString());
            updateWaterDisplay();
            alert(`‚úÖ Meta de √°gua atualizada para ${waterGoal}ml!`);
        }

        function resetWater() {
            if (confirm('Resetar contador de √°gua?')) {
                dailyLog.water = 0;
                updateWaterDisplay();
                saveWaterToFirebase();
            }
        }

        // ==================== COPIAR DIA ANTERIOR ====================
        async function copyYesterday() {
            if (!confirm('Copiar todas as refei√ß√µes de ontem para hoje?')) return;
            
            try {
                // Calcula data de ontem
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                let yesterdayLog;
                
                if (!currentUser || useLocalStorage) {
                    // Modo local
                    const stored = localStorage.getItem('macromixer_log_' + yesterdayStr);
                    if (!stored) {
                        alert('N√£o h√° dados de ontem para copiar.');
                        return;
                    }
                    yesterdayLog = JSON.parse(stored);
                } else {
                    // Modo Firebase
                    const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', yesterdayStr);
                    const docSnap = await getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        alert('N√£o h√° dados de ontem para copiar.');
                        return;
                    }
                    yesterdayLog = docSnap.data();
                }
                
                if (!yesterdayLog.items || yesterdayLog.items.length === 0) {
                    alert('Ontem n√£o h√° refei√ß√µes registradas.');
                    return;
                }
                
                // Copia os items
                for (const item of yesterdayLog.items) {
                    dailyLog.items.push({...item, timestamp: new Date().toISOString()});
                }
                
                // Recalcula totais
                recalculateTotals();
                
                // Salva
                if (!currentUser || useLocalStorage) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    localStorage.setItem('macromixer_log_' + todayStr, JSON.stringify(dailyLog));
                } else {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', todayStr);
                    await setDoc(docRef, dailyLog);
                }
                
                // Atualiza UI
                renderLogs();
                updateDashboard();
                analyzeContext();
                
                alert(`‚úÖ ${yesterdayLog.items.length} refei√ß√µes copiadas com sucesso!`);
            } catch (error) {
                console.error('Erro ao copiar dia anterior:', error);
                alert('Erro ao copiar refei√ß√µes. Tente novamente.');
            }
        }

        function recalculateTotals() {
            console.log('üîÑ recalculateTotals chamado');
            console.log('   Items antes:', dailyLog.items.length);
            console.log('   Items:', dailyLog.items);
            
            dailyLog.total = { cals: 0, prot: 0, carb: 0, fat: 0 };
            for (const item of dailyLog.items) {
                console.log('   Somando item:', item.name, {cals: item.cals, prot: item.prot, carb: item.carb, fat: item.fat});
                
                // Robustez: tenta usar propriedades diretas, depois totals, depois 0
                const iCals = item.cals ?? item.totals?.kcal ?? 0;
                const iProt = item.prot ?? item.totals?.p ?? 0;
                const iCarb = item.carb ?? item.totals?.c ?? 0;
                const iFat = item.fat ?? item.totals?.f ?? 0;
                
                dailyLog.total.cals += iCals;
                dailyLog.total.prot += iProt;
                dailyLog.total.carb += iCarb;
                dailyLog.total.fat += iFat;
            }
            
            console.log('   Total calculado:', dailyLog.total);
        }

        // ==================== MODO ESCURO/CLARO ====================
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            
            const icon = document.getElementById('theme-icon');
            if (isDarkMode) {
                icon.className = 'fa-solid fa-moon';
            } else {
                icon.className = 'fa-solid fa-sun';
            }
            
            // Salva prefer√™ncia
            localStorage.setItem('macromixer_theme', isDarkMode ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('macromixer_theme');
            if (savedTheme === 'light') {
                isDarkMode = false;
                document.body.classList.add('light-mode');
                document.getElementById('theme-icon').className = 'fa-solid fa-sun';
            }
        }

        // ==================== REGISTRO DE PESO ====================
        async function saveWeight() {
            const weightInput = document.getElementById('weight-input');
            const weight = parseFloat(weightInput.value);
            
            if (!weight || weight < 30 || weight > 300) {
                alert('Por favor, insira um peso v√°lido (30-300kg)');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const entry = { date: today, weight: weight };
            
            // Salva no Firebase ou localStorage
            if (!currentUser || useLocalStorage) {
                let history = JSON.parse(localStorage.getItem('macromixer_weight_history') || '[]');
                // Remove entrada do mesmo dia se existir
                history = history.filter(e => e.date !== today);
                history.push(entry);
                history.sort((a, b) => new Date(a.date) - new Date(b.date));
                localStorage.setItem('macromixer_weight_history', JSON.stringify(history));
                weightHistory = history;
            } else {
                try {
                    const docRef = doc(db, 'users', currentUser.uid, 'weight_history', today);
                    await setDoc(docRef, entry);
                    await loadWeightHistory();
                } catch (error) {
                    console.error('Erro ao salvar peso:', error);
                    alert('Erro ao salvar peso. Tente novamente.');
                    return;
                }
            }
            
            weightInput.value = '';
            updateWeightDisplay();
            alert('‚úÖ Peso registrado com sucesso!');
        }

        async function loadWeightHistory() {
            if (!currentUser || useLocalStorage) {
                weightHistory = JSON.parse(localStorage.getItem('macromixer_weight_history') || '[]');
            } else {
                try {
                    const collectionRef = collection(db, 'users', currentUser.uid, 'weight_history');
                    const querySnapshot = await getDocs(collectionRef);
                    weightHistory = [];
                    querySnapshot.forEach((doc) => {
                        weightHistory.push(doc.data());
                    });
                    weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                } catch (error) {
                    console.error('Erro ao carregar hist√≥rico de peso:', error);
                }
            }
            updateWeightDisplay();
        }

        function updateWeightDisplay() {
            // Elemento removido na v3.2.2 - fun√ß√£o desabilitada
            const weightInfoEl = document.getElementById('weight-info');
            if (!weightInfoEl) return;
            
            if (weightHistory.length === 0) {
                weightInfoEl.innerHTML = '<i class="fa-solid fa-info-circle mr-1"></i>Registre seu peso diariamente';
                return;
            }
            
            const latest = weightHistory[weightHistory.length - 1];
            const initial = weightHistory[0];
            const diff = latest.weight - initial.weight;
            
            weightInfoEl.innerHTML = `<i class="fa-solid fa-check-circle mr-1 text-green-400"></i><span class="text-green-400">√öltimo: ${latest.weight}kg em ${new Date(latest.date).toLocaleDateString('pt-BR')}</span>`;
            
            // Atualiza stats
            document.getElementById('weight-initial').innerText = initial.weight + 'kg';
            document.getElementById('weight-current').innerText = latest.weight + 'kg';
            
            const diffEl = document.getElementById('weight-diff');
            if (diff > 0) {
                diffEl.innerText = '+' + diff.toFixed(1) + 'kg';
                diffEl.className = 'font-bold text-red-400';
            } else if (diff < 0) {
                diffEl.innerText = diff.toFixed(1) + 'kg';
                diffEl.className = 'font-bold text-green-400';
            } else {
                diffEl.innerText = '0kg';
                diffEl.className = 'font-bold text-slate-400';
            }
        }

        function toggleWeightChart() {
            const container = document.getElementById('weight-chart-container');
            container.classList.toggle('hidden');
            
            if (!container.classList.contains('hidden')) {
                renderWeightChart();
            }
        }

        function renderWeightChart() {
            if (weightHistory.length === 0) {
                return;
            }
            
            const ctx = document.getElementById('weight-chart').getContext('2d');
            
            if (weightChart) {
                weightChart.destroy();
            }
            
            const labels = weightHistory.map(e => new Date(e.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            const data = weightHistory.map(e => e.weight);
            
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Peso (kg)',
                        data: data,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value + 'kg';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== REFEI√á√ïES FAVORITAS ====================
        async function loadFavoriteMeals() {
            if (currentUser && !useLocalStorage) {
                try {
                    const docRef = doc(db, 'users', currentUser.uid, 'settings', 'favorites');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        favoriteMeals = docSnap.data().meals || [];
                    }
                } catch (error) {
                    console.error('Erro ao carregar favoritos:', error);
                    const stored = localStorage.getItem('macromixer_favorites');
                    favoriteMeals = stored ? JSON.parse(stored) : [];
                }
            } else {
                const stored = localStorage.getItem('macromixer_favorites');
                favoriteMeals = stored ? JSON.parse(stored) : [];
            }
            renderFavorites();
        }

        async function saveFavoriteMeal() {
            if (!tempMealAnalysis) {
                alert('‚ö†Ô∏è Calcule uma refei√ß√£o primeiro!');
                return;
            }

            const name = prompt('üìù Nome da refei√ß√£o favorita:', tempMealAnalysis.mealName || 'Refei√ß√£o');
            if (!name) return;

            const favorite = {
                id: Date.now(),
                name: name,
                foods: tempMealAnalysis.foods,
                totals: tempMealAnalysis.totals,
                isApproximate: tempMealAnalysis.isApproximate,
                createdAt: new Date().toISOString()
            };

            favoriteMeals.push(favorite);

            // Salva no Firebase ou localStorage
            if (currentUser && !useLocalStorage) {
                try {
                    const docRef = doc(db, 'users', currentUser.uid, 'settings', 'favorites');
                    await setDoc(docRef, { meals: favoriteMeals }, { merge: true });
                    console.log('‚úÖ Favorito salvo no Firebase!');
                } catch (error) {
                    console.error('‚ùå Erro ao salvar favorito:', error);
                    localStorage.setItem('macromixer_favorites', JSON.stringify(favoriteMeals));
                }
            } else {
                localStorage.setItem('macromixer_favorites', JSON.stringify(favoriteMeals));
            }

            renderFavorites();
            alert('‚≠ê Refei√ß√£o salva nos favoritos!');
        }

        async function deleteFavorite(id) {
            if (!confirm('üóëÔ∏è Deletar esta refei√ß√£o favorita?')) return;

            favoriteMeals = favoriteMeals.filter(f => f.id !== id);

            // Salva no Firebase ou localStorage
            if (currentUser && !useLocalStorage) {
                try {
                    const docRef = doc(db, 'users', currentUser.uid, 'settings', 'favorites');
                    await setDoc(docRef, { meals: favoriteMeals }, { merge: true });
                } catch (error) {
                    console.error('‚ùå Erro ao deletar favorito:', error);
                    localStorage.setItem('macromixer_favorites', JSON.stringify(favoriteMeals));
                }
            } else {
                localStorage.setItem('macromixer_favorites', JSON.stringify(favoriteMeals));
            }

            renderFavorites();
        }

        function useFavorite(id) {
            const favorite = favoriteMeals.find(f => f.id === id);
            if (!favorite) return;

            // Reconstr√≥i o texto da refei√ß√£o
            const mealText = favorite.foods.map(food => {
                return `${food.qtd} ${food.unitDisplay} ${food.rawName}`;
            }).join('\n');

            // Preenche o campo de entrada
            document.getElementById('meal-input').value = mealText;

            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });

            alert('‚úÖ Refei√ß√£o carregada! Clique em "Calcular" para adicionar.');
        }

        function renderFavorites() {
            const container = document.getElementById('favorites-container');
            
            if (favoriteMeals.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-500 text-xs py-4">
                        <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma refei√ß√£o favorita ainda
                    </div>
                `;
                return;
            }

            container.innerHTML = favoriteMeals.map(fav => `
                <div class="bg-slate-800/50 rounded-lg p-3 border border-amber-900/30">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="text-sm font-bold text-amber-400">${fav.name}</div>
                            <div class="text-xs text-slate-400 mt-1">
                                ${fav.totals.kcal} kcal | 
                                P:${fav.totals.p}g C:${fav.totals.c}g G:${fav.totals.f}g
                            </div>
                        </div>
                        <button onclick="deleteFavorite(${fav.id})" class="text-xs text-red-400 hover:text-red-300 ml-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <button onclick="useFavorite(${fav.id})" class="w-full bg-amber-700 hover:bg-amber-600 text-white text-xs font-bold py-2 rounded transition-all">
                        <i class="fa-solid fa-plus mr-1"></i>Usar Esta Refei√ß√£o
                    </button>
                </div>
            `).join('');
        }

        // ==================== GR√ÅFICO DE MACROS ====================
        function toggleMacrosChart() {
            const container = document.getElementById('macros-chart-container');
            const placeholder = document.getElementById('macros-chart-placeholder');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                placeholder.classList.add('hidden');
                renderMacrosChart();
            } else {
                container.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function renderMacrosChart() {
            const t = dailyLog.total || { prot: 0, carb: 0, fat: 0 };
            
            // Calcula calorias de cada macro
            const protCals = (t.prot || 0) * 4;
            const carbCals = (t.carb || 0) * 4;
            const fatCals = (t.fat || 0) * 9;
            const totalCals = protCals + carbCals + fatCals;
            
            const placeholderEl = document.getElementById('macros-chart-placeholder');
            const containerEl = document.getElementById('macros-chart-container');
            
            if (totalCals === 0) {
                if (placeholderEl) placeholderEl.classList.remove('hidden');
                if (containerEl) containerEl.classList.add('hidden');
                return;
            }
            
            if (placeholderEl) placeholderEl.classList.add('hidden');
            if (containerEl) containerEl.classList.remove('hidden');
            
            // Calcula percentuais
            const protPercent = ((protCals / totalCals) * 100).toFixed(1);
            const carbPercent = ((carbCals / totalCals) * 100).toFixed(1);
            const fatPercent = ((fatCals / totalCals) * 100).toFixed(1);
            
            // Atualiza percentuais (com verifica√ß√£o de exist√™ncia)
            const protPercentEl = document.getElementById('macro-prot-percent');
            const carbPercentEl = document.getElementById('macro-carb-percent');
            const fatPercentEl = document.getElementById('macro-fat-percent');
            
            if (protPercentEl) protPercentEl.textContent = protPercent + '%';
            if (carbPercentEl) carbPercentEl.textContent = carbPercent + '%';
            if (fatPercentEl) fatPercentEl.textContent = fatPercent + '%';
            
            // Cria/atualiza gr√°fico
            const ctx = document.getElementById('macros-chart').getContext('2d');
            
            if (macrosChart) {
                macrosChart.destroy();
            }
            
            macrosChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Prote√≠na', 'Carboidrato', 'Gordura'],
                    datasets: [{
                        data: [protCals, carbCals, fatCals],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',   // green
                            'rgba(59, 130, 246, 0.8)',  // blue
                            'rgba(234, 179, 8, 0.8)'    // yellow
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(234, 179, 8, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 11 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percent = ((value / totalCals) * 100).toFixed(1);
                                    return `${label}: ${value.toFixed(0)} kcal (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== GALERIA DE FOTOS (OLD VERSION - REMOVED, SEE GALLERY FUNCTIONS SECTION BELOW) ====================

        function renderGalleryPreview(photos = null) {
            const preview = document.getElementById('gallery-preview');
            
            if (!photos) {
                photos = [];
                dailyLog.items.forEach(meal => {
                    if (meal.photo) {
                        photos.push({
                            url: meal.photo,
                            name: meal.name
                        });
                    }
                });
            }
            
            if (photos.length === 0) {
                preview.innerHTML = `
                    <div class="text-center text-slate-500 text-xs py-4 col-span-4">
                        <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma foto ainda
                    </div>
                `;
                return;
            }
            
            // Mostra at√© 4 fotos mais recentes
            const recentPhotos = photos.slice(-4);
            preview.innerHTML = recentPhotos.map(photo => `
                <div class="relative group cursor-pointer" onclick="showMealPhoto('${photo.url}')">
                    <img src="${photo.url}" class="w-full h-16 object-cover rounded border border-slate-700" alt="${photo.name}" />
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center">
                        <i class="fa-solid fa-search-plus text-white text-sm"></i>
                    </div>
                </div>
            `).join('');
        }

        // ==================== FOTO DAS REFEI√á√ïES (FIREBASE STORAGE) ====================
        async function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Limita tamanho (max 12MB - iPhone 15 Pro Max tira fotos de at√© 10MB)
            if (file.size > 12 * 1024 * 1024) {
                alert('üì∏ Foto muito grande! M√°ximo 12MB.');
                return;
            }
            
            // Preview local enquanto faz upload
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photo-preview-img').src = e.target.result;
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('remove-photo-btn').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            // Upload para Firebase Storage (se online)
            if (currentUser && !useLocalStorage) {
                try {
                    const timestamp = Date.now();
                    const fileName = `meal_${currentUser.uid}_${timestamp}.jpg`;
                    const storageRef = ref(storage, `meal_photos/${fileName}`);
                    
                    console.log('üì§ Fazendo upload da foto...');
                    await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    currentMealPhoto = downloadURL; // URL da foto no Storage
                    console.log('‚úÖ Foto enviada com sucesso!', downloadURL);
                } catch (error) {
                    console.error('‚ùå Erro ao fazer upload da foto:', error);
                    alert('‚ö†Ô∏è Erro ao enviar foto. Continuando sem foto.');
                    currentMealPhoto = null;
                }
            } else {
                // Modo offline: salva base64 no localStorage (limitado)
                currentMealPhoto = reader.result;
            }
        }

        function removePhoto() {
            currentMealPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('remove-photo-btn').classList.add('hidden');
            document.getElementById('meal-photo-input').value = '';
        }

        function showMealPhoto(photoURL) {
            if (!photoURL) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="relative max-w-2xl w-full">
                    <button class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300" onclick="this.closest('.fixed').remove()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <img src="${photoURL}" class="w-full rounded-lg shadow-2xl" alt="Foto da Refei√ß√£o" />
                </div>
            `;
            document.body.appendChild(modal);
            
            // Fecha ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function renderLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            if (!dailyLog.items || dailyLog.items.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-600 py-4 italic text-sm">Nenhuma refei√ß√£o hoje.</div>';
                return;
            }
            dailyLog.items.slice().reverse().forEach((log, reverseIndex) => {
                const actualIndex = dailyLog.items.length - 1 - reverseIndex;
                const el = document.createElement('div');
                // Prote√ß√£o contra logs antigos sem isApproximate
                const isApprox = log.isApproximate || false;
                const borderClass = isApprox ? 'border-yellow-500' : 'border-cyan-500';
                const bgClass = isApprox ? 'bg-yellow-900/10' : 'bg-slate-800/50';
                el.className = `${bgClass} rounded-lg p-3 border-l-2 ${borderClass}`;
                
                // Prote√ß√£o contra foods undefined
                const foodDesc = (log.foods && log.foods.length > 0) 
                    ? log.foods.map(f => f.name.split(' ')[0]).join(', ')
                    : 'Refei√ß√£o';
                    
                const photoIcon = log.photo ? '<i class="fa-solid fa-camera text-cyan-400 text-[10px] ml-1" title="Com foto"></i>' : '';
                
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1" ${log.photo ? 'style="cursor: pointer;"' : ''}>
                            <div class="text-sm font-bold text-gray-200">
                                ${log.name || 'Refei√ß√£o'} 
                                ${isApprox ? '<i class="fa-solid fa-triangle-exclamation text-yellow-500 text-[10px]" title="Aproximado"></i>' : ''}
                                ${photoIcon}
                            </div>
                            <div class="text-xs text-gray-500 truncate w-40">${foodDesc}</div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="text-sm font-bold text-white">${log.totals.kcal || 0} kcal</div>
                            <div class="text-[10px] text-gray-400 flex gap-2 font-mono">
                                <span class="text-green-500">P:${log.totals.p || 0}</span>
                                <span class="text-blue-500">C:${log.totals.c || 0}</span>
                                <span class="text-yellow-500">G:${log.totals.f || 0}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2 pt-2 border-t border-slate-700">
                        <button class="edit-meal-btn flex-1 bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded transition-all" data-index="${actualIndex}">
                            <i class="fa-solid fa-edit mr-1"></i>Editar
                        </button>
                        <button class="delete-meal-btn flex-1 bg-red-700 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded transition-all" data-index="${actualIndex}">
                            <i class="fa-solid fa-trash mr-1"></i>Deletar
                        </button>
                    </div>
                `;
                
                // Se tiver foto, adiciona click para ver (apenas na √°rea do nome)
                if (log.photo) {
                    const nameArea = el.querySelector('.flex-1');
                    nameArea.addEventListener('click', () => showMealPhoto(log.photo));
                }
                
                // Event listeners para os bot√µes
                const editBtn = el.querySelector('.edit-meal-btn');
                const deleteBtn = el.querySelector('.delete-meal-btn');
                
                editBtn.addEventListener('click', () => editMeal(actualIndex));
                deleteBtn.addEventListener('click', () => deleteMeal(actualIndex));
                
                container.appendChild(el);
            });
            
            // Atualiza galeria de fotos
            renderGalleryPreview();
        }

        // ==================== EDITAR E DELETAR REFEI√á√ïES ====================
        async function editMeal(index) {
            const meal = dailyLog.items[index];
            if (!meal) return;
            
            // Reconstr√≥i o texto da refei√ß√£o
            const mealText = meal.foods.map(food => {
                return `${food.qtd} ${food.unitDisplay} ${food.rawName}`;
            }).join('\n');
            
            // Preenche o campo de entrada
            document.getElementById('meal-input').value = mealText;
            
            // Remove a refei√ß√£o antiga
            await deleteMeal(index, false); // false = n√£o atualizar UI ainda
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            alert('‚úèÔ∏è Refei√ß√£o carregada para edi√ß√£o! Fa√ßa as altera√ß√µes e clique em "Calcular".');
        }
        
        async function deleteMeal(index, updateUI = true) {
            if (updateUI && !confirm('üóëÔ∏è Deletar esta refei√ß√£o?')) return;
            
            const meal = dailyLog.items[index];
            if (!meal) return;
            
            // Remove do array
            dailyLog.items.splice(index, 1);
            
            // Recalcula total
            dailyLog.total = { cals: 0, prot: 0, carb: 0, fat: 0 };
            dailyLog.items.forEach(item => {
                dailyLog.total.cals += item.totals.kcal || 0;
                dailyLog.total.prot += item.totals.p || 0;
                dailyLog.total.carb += item.totals.c || 0;
                dailyLog.total.fat += item.totals.f || 0;
            });
            
            // Salva no Firebase/localStorage
            if (currentUser && !useLocalStorage) {
                try {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const docRef = doc(db, 'users', currentUser.uid, 'daily_logs', todayStr);
                    await setDoc(docRef, { 
                        items: dailyLog.items, 
                        total: dailyLog.total,
                        water: dailyLog.water || 0
                    }, { merge: true });
                    console.log('‚úÖ Refei√ß√£o deletada com sucesso!');
                } catch (error) {
                    console.error('‚ùå Erro ao deletar refei√ß√£o:', error);
                    alert('‚ö†Ô∏è Erro ao deletar refei√ß√£o.');
                }
            } else {
                saveToLocalStorage();
            }
            
            if (updateUI) {
                renderLogs();
                updateDashboard();
                analyzeContext();
            }
        }

        // --- DR CARLOS AI (VARI√ÅVEL) ---
        function analyzeContext() {
            const t = dailyLog.total;
            const g = userSettings;
            const weight = g.weight || 93;
            const minProtein = weight * 2.5; 

            const box = document.getElementById('suggestion-box');
            const txt = document.getElementById('suggestion-text');
            box.classList.remove('hidden');

            const pctKcal = t.cals / g.cals;
            
            // Phrases DB
            const phrases = {
                catabolic: [
                    "<b>ALERTA DE CATABOLISMO!</b> A prote√≠na est√° baixa. O m√∫sculo n√£o cresce com ar. Mande Whey ou Ovos agora.",
                    "Voc√™ est√° brincando de fazer dieta? Prote√≠na rid√≠cula. Corrija isso antes de dormir ou perder√° massa.",
                    "Seu corpo est√° implorando por amino√°cidos. A s√≠ntese proteica parou. Coma prote√≠na IMEDIATAMENTE."
                ],
                overLimit: [
                    "Meta cal√≥rica estourada. Pare de comer. O GH age no sono, n√£o na digest√£o pesada.",
                    "Voc√™ j√° passou do limite. Beba 1 litro de √°gua e v√° dormir. Amanh√£ o cardio ser√° dobrado.",
                    "Chega por hoje. Seu saldo acabou. N√£o transforme super√°vit em gordura visceral."
                ],
                massacreNeedCarb: [
                    "Hoje √© dia de <b>MASSACRE</b> e seu carbo est√° baixo. O treino vai falhar sem glicog√™nio. Carregue agora.",
                    "Sem carbo, sem for√ßa. √â dia de perna/costas? Coma arroz ou batata j√°.",
                    "A insulina precisa subir pro treino render. O tanque est√° vazio. Encha de carbo limpo."
                ],
                onTrack: [
                    `Protocolo em andamento. Voc√™ tem <b>${g.cals - t.cals} kcal</b> de buffer. Mantenha a disciplina.`,
                    "Segue o plano. A const√¢ncia √© o segredo. N√£o erra.",
                    "Engenharia metab√≥lica funcionando. Tudo dentro dos par√¢metros. Continue focado."
                ]
            };

            const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

            // Logic Tree
            if (t.prot < minProtein && pctKcal > 0.8) {
                txt.innerHTML = getRandom(phrases.catabolic);
                box.className = "bg-red-900/30 border-l-4 border-red-500 p-3 rounded text-sm text-red-200";
            } else if (pctKcal > 1.05) {
                txt.innerHTML = getRandom(phrases.overLimit);
                box.className = "bg-red-900/30 border-l-4 border-red-500 p-3 rounded text-sm text-red-200";
            } else if (g.carb > 150 && t.carb < 50 && pctKcal > 0.4) {
                 txt.innerHTML = getRandom(phrases.massacreNeedCarb);
                 box.className = "bg-blue-900/30 border-l-4 border-blue-500 p-3 rounded text-sm text-blue-200";
            } else {
                 txt.innerHTML = getRandom(phrases.onTrack);
                 box.className = "bg-slate-800/50 border-l-4 border-cyan-500 p-3 rounded text-sm text-gray-300";
            }
        }

        // --- MULTI-DAY HISTORY FUNCTIONS ---
        function formatDateDisplay(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return "Hoje";
            if (date.toDateString() === yesterday.toDateString()) return "Ontem";
            
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function updateDateDisplay() {
            document.getElementById('current-date-display').innerText = formatDateDisplay(currentViewDate);
            
            // Disable next button if viewing today
            const today = new Date();
            const isToday = currentViewDate.toDateString() === today.toDateString();
            document.getElementById('next-day-btn').disabled = isToday;
            document.getElementById('next-day-btn').style.opacity = isToday ? '0.3' : '1';
        }

        function changeViewDate(days) {
            currentViewDate.setDate(currentViewDate.getDate() + days);
            updateDateDisplay();
            loadDailyLog();
        }

        // Fun√ß√µes simplificadas - apenas localStorage
        async function loadDailyLogForDate(date) {
            loadDailyLogLocal();
            renderLogs();
            updateDashboard();
            
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                analyzeContext();
            }
        }

        async function loadWeeklyData() {
            return await loadWeeklyDataLocal();
        }

        async function renderWeeklyChart() {
            const weekData = await loadWeeklyData();
            
            const ctx = document.getElementById('weekly-chart').getContext('2d');
            
            if (weeklyChart) weeklyChart.destroy();
            
            const datasets = [
                {
                    label: 'Calorias',
                    data: weekData.map(d => d.total.cals),
                    borderColor: 'rgb(168, 85, 247)',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Prote√≠na (g)',
                    data: weekData.map(d => d.total.prot),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ];
            
            // Add comparison if selected
            if (comparisonDay) {
                const comparisonData = weekData.find(d => d.date === comparisonDay);
                if (comparisonData) {
                    const comparisonIndex = weekData.findIndex(d => d.date === comparisonDay);
                    
                    // Highlight comparison day
                    datasets.push({
                        label: `Compara√ß√£o: ${comparisonDay}`,
                        data: weekData.map((d, i) => i === comparisonIndex ? d.total.cals : null),
                        borderColor: 'rgb(251, 191, 36)',
                        backgroundColor: 'rgba(251, 191, 36, 0.3)',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        yAxisID: 'y',
                        borderWidth: 3,
                        borderDash: [5, 5]
                    });
                }
            }
            
            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekData.map(d => d.label),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            labels: { color: '#e2e8f0', font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (comparisonDay && context.datasetIndex === 2) {
                                        const dayData = weekData[context.dataIndex];
                                        return [
                                            `Prote√≠na: ${Math.round(dayData.total.prot)}g`,
                                            `Carbos: ${Math.round(dayData.total.carb)}g`,
                                            `Gordura: ${Math.round(dayData.total.fat)}g`
                                        ];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#a855f7' },
                            grid: { color: 'rgba(71, 85, 105, 0.3)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#22c55e' },
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(71, 85, 105, 0.3)' }
                        }
                    }
                }
            });
            
            // Render summary
            renderWeeklySummary(weekData);
        }

        function renderWeeklySummary(weekData) {
            const container = document.getElementById('weekly-summary');
            container.innerHTML = '';
            
            const totalCals = weekData.reduce((sum, d) => sum + d.total.cals, 0);
            const avgCals = Math.round(totalCals / 7);
            const totalProt = weekData.reduce((sum, d) => sum + d.total.prot, 0);
            const avgProt = Math.round(totalProt / 7);
            
            const daysOnTrack = weekData.filter(d => 
                d.total.cals >= userSettings.cals * 0.9 && 
                d.total.cals <= userSettings.cals * 1.1
            ).length;
            
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 rounded p-3 text-center">
                        <div class="text-xs text-purple-400 uppercase font-bold mb-1">M√©dia Calorias</div>
                        <div class="text-2xl font-bold text-white">${avgCals}</div>
                        <div class="text-xs text-gray-500">kcal/dia</div>
                    </div>
                    <div class="bg-slate-800/50 rounded p-3 text-center">
                        <div class="text-xs text-green-400 uppercase font-bold mb-1">M√©dia Prote√≠na</div>
                        <div class="text-2xl font-bold text-white">${avgProt}g</div>
                        <div class="text-xs text-gray-500">/dia</div>
                    </div>
                    <div class="bg-slate-800/50 rounded p-3 text-center col-span-2">
                        <div class="text-xs text-cyan-400 uppercase font-bold mb-1">Dias no Alvo</div>
                        <div class="text-2xl font-bold text-white">${daysOnTrack}/7</div>
                        <div class="text-xs text-gray-500">dentro da meta (¬±10%)</div>
                    </div>
                </div>
            `;
        }

        // --- NOTIFICATION FUNCTIONS (OLD - REMOVED, SEE PUSH NOTIFICATIONS SECTION BELOW) ---
        
        function showNotificationOld(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/3480/3480822.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/3480/3480822.png'
                });
            }
        }

        function checkNotifications() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            if (notificationSettings.breakfast.enabled && currentTime === notificationSettings.breakfast.time) {
                showNotification('‚òÄÔ∏è Caf√© da Manh√£', 'Hora do caf√© da manh√£! N√£o esque√ßa de registrar sua refei√ß√£o.');
            }
            if (notificationSettings.lunch.enabled && currentTime === notificationSettings.lunch.time) {
                showNotification('üçΩÔ∏è Almo√ßo', 'Hora do almo√ßo! Mantenha sua dieta em dia.');
            }
            if (notificationSettings.dinner.enabled && currentTime === notificationSettings.dinner.time) {
                showNotification('üåô Jantar', 'Hora do jantar! Lembre-se de registrar suas macros.');
            }
        }

        function startNotificationScheduler() {
            // Clear existing intervals
            notificationIntervals.forEach(interval => clearInterval(interval));
            notificationIntervals = [];
            
            // Check every minute
            const interval = setInterval(checkNotifications, 60000);
            notificationIntervals.push(interval);
            
            // Check intelligent notifications every 30 minutes
            const intelligentInterval = setInterval(checkIntelligentNotifications, 30 * 60000);
            notificationIntervals.push(intelligentInterval);
        }

        function checkIntelligentNotifications() {
            const now = new Date();
            const hour = now.getHours();
            
            // S√≥ notifica entre 8h e 22h
            if (hour < 8 || hour > 22) return;
            
            const t = dailyLog.total;
            const g = userSettings;
            
            // Verifica se est√° muito abaixo da meta (menos de 50% e j√° √© tarde)
            if (hour >= 18) {
                const pctCals = t.cals / g.cals;
                if (pctCals < 0.5) {
                    showNotification('‚ö†Ô∏è Aten√ß√£o!', `Voc√™ est√° com apenas ${Math.round(pctCals * 100)}% das calorias do dia. N√£o esque√ßa de comer!`);
                }
                
                const pctProt = t.prot / g.prot;
                if (pctProt < 0.5) {
                    showNotification('ü•© Prote√≠na Baixa!', `Voc√™ est√° com apenas ${Math.round(pctProt * 100)}% da prote√≠na do dia. Coma mais prote√≠na!`);
                }
            }
            
            // Verifica se n√£o registrou refei√ß√£o h√° muito tempo
            if (dailyLog.items && dailyLog.items.length > 0) {
                const lastMeal = dailyLog.items[dailyLog.items.length - 1];
                const lastMealTime = new Date(lastMeal.timestamp);
                const hoursSinceLastMeal = (now - lastMealTime) / (1000 * 60 * 60);
                
                if (hoursSinceLastMeal >= 4 && hour >= 12 && hour <= 20) {
                    showNotification('üçΩÔ∏è Hora de Comer!', `J√° se passaram ${Math.floor(hoursSinceLastMeal)} horas desde sua √∫ltima refei√ß√£o!`);
                }
            }
            
            // Verifica hidrata√ß√£o
            const waterPct = (dailyLog.water || 0) / waterGoal;
            if (hour >= 16 && waterPct < 0.5) {
                showNotification('üíß Beba √Ågua!', `Voc√™ bebeu apenas ${Math.round(waterPct * 100)}% da meta de √°gua hoje!`);
            }
            
            // Parabeniza se bateu a meta
            if (t.cals >= g.cals * 0.95 && t.cals <= g.cals * 1.05 && t.prot >= g.prot * 0.95) {
                const lastCongrats = localStorage.getItem('macromixer_last_congrats');
                const today = new Date().toISOString().split('T')[0];
                
                if (lastCongrats !== today) {
                    showNotification('üéâ Parab√©ns!', 'Voc√™ bateu suas metas de hoje! Continue assim!');
                    localStorage.setItem('macromixer_last_congrats', today);
                }
            }
        }

        // Fun√ß√µes com Firebase
        async function loadNotificationSettings() {
            if (!currentUser) return;
            const docRef = doc(db, 'users', currentUser.uid, 'settings', 'notifications');
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    notificationSettings = docSnap.data();
                    updateNotificationUI();
                }
            } catch (error) {
                console.log("Error loading notification settings", error);
            }
        }

        async function saveNotificationSettings() {
            if (!currentUser) return;
            
            const newSettings = {
                breakfast: {
                    time: document.getElementById('breakfast-time').value,
                    enabled: document.getElementById('breakfast-enabled').checked
                },
                lunch: {
                    time: document.getElementById('lunch-time').value,
                    enabled: document.getElementById('lunch-enabled').checked
                },
                dinner: {
                    time: document.getElementById('dinner-time').value,
                    enabled: document.getElementById('dinner-enabled').checked
                }
            };
            
            const docRef = doc(db, 'users', currentUser.uid, 'settings', 'notifications');
            await setDoc(docRef, newSettings);
            notificationSettings = newSettings;
            
            startNotificationScheduler();
            
            const btn = document.getElementById('save-notifications-btn');
            const originalText = btn.innerText;
            btn.innerText = "‚úì SALVO!";
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-600');
            }, 1500);
            
            updateNotificationStatus();
        }

        function updateNotificationUI() {
            document.getElementById('breakfast-time').value = notificationSettings.breakfast.time;
            document.getElementById('breakfast-enabled').checked = notificationSettings.breakfast.enabled;
            document.getElementById('lunch-time').value = notificationSettings.lunch.time;
            document.getElementById('lunch-enabled').checked = notificationSettings.lunch.enabled;
            document.getElementById('dinner-time').value = notificationSettings.dinner.time;
            document.getElementById('dinner-enabled').checked = notificationSettings.dinner.enabled;
            
            updateNotificationStatus();
        }

        function updateNotificationStatus() {
            const anyEnabled = notificationSettings.breakfast.enabled || 
                               notificationSettings.lunch.enabled || 
                               notificationSettings.dinner.enabled;
            
            const statusEl = document.getElementById('notification-status');
            if (anyEnabled) {
                statusEl.innerHTML = '<i class="fa-solid fa-check-circle text-green-500 mr-1"></i>Lembretes ativos!';
                statusEl.className = 'text-xs text-green-400 text-center py-2';
            } else {
                statusEl.innerHTML = '<i class="fa-solid fa-info-circle mr-1"></i>Configure seus lembretes para n√£o esquecer de comer!';
                statusEl.className = 'text-xs text-gray-400 text-center py-2';
            }
        }

        // --- EXPORT FUNCTIONS ---
        async function exportToCSV() {
            const weekData = await loadWeeklyData();
            
            let csv = 'Data,Calorias,Prote√≠na,Carboidrato,Gordura\n';
            weekData.forEach(day => {
                csv += `${day.date},${day.total.cals},${day.total.prot},${day.total.carb},${day.total.fat}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `macromixer_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportToJSON() {
            const weekData = await loadWeeklyData();
            
            const exportData = {
                exportDate: new Date().toISOString(),
                userSettings: userSettings,
                weeklyData: weekData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `macromixer_export_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- SHARE FUNCTIONS ---
        function openShareModal() {
            document.getElementById('share-cals').textContent = Math.round(dailyLog.total.cals);
            document.getElementById('share-prot').textContent = Math.round(dailyLog.total.prot) + 'g';
            document.getElementById('share-carb').textContent = Math.round(dailyLog.total.carb) + 'g';
            document.getElementById('share-fat').textContent = Math.round(dailyLog.total.fat) + 'g';
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function generateShareText() {
            const date = currentViewDate.toLocaleDateString('pt-BR');
            const cals = Math.round(dailyLog.total.cals);
            const prot = Math.round(dailyLog.total.prot);
            const carb = Math.round(dailyLog.total.carb);
            const fat = Math.round(dailyLog.total.fat);
            const meals = dailyLog.items.length;
            const water = dailyLog.water || 0;
            
            const goalPercent = userSettings.cals > 0 ? Math.round((cals / userSettings.cals) * 100) : 0;
            
            return `üî• *MacroMixer - ${date}*\n\n` +
                   `üìä *Resumo do Dia:*\n` +
                   `üçΩÔ∏è ${meals} refei√ß√µes registradas\n` +
                   `üíß ${water}ml de √°gua\n\n` +
                   `‚ö° *Macros:*\n` +
                   `‚Ä¢ ${cals} kcal (${goalPercent}% da meta)\n` +
                   `‚Ä¢ ${prot}g Prote√≠na üí™\n` +
                   `‚Ä¢ ${carb}g Carboidrato üçö\n` +
                   `‚Ä¢ ${fat}g Gordura ü•ë\n\n` +
                   `‚ú® _Rastreado com MacroMixer - Dr. Carlos Edition_`;
        }

        function shareToWhatsApp() {
            const text = generateShareText();
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
            closeShareModal();
        }

        function copyShareText() {
            const text = generateShareText();
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Texto copiado! Cole onde quiser.');
                closeShareModal();
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('‚ùå Erro ao copiar texto.');
            });
        }

        // --- PUSH NOTIFICATIONS ---
        let notificationPermission = 'default';
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Notifica√ß√µes n√£o suportadas neste navegador');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                notificationPermission = 'granted';
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                return permission === 'granted';
            }
            
            return false;
        }

        function showNotification(title, body, icon = 'üçΩÔ∏è') {
            if (notificationPermission !== 'granted') return;
            
            try {
                new Notification(title, {
                    body: body,
                    icon: './icon-192.svg',
                    badge: './icon-192.svg',
                    tag: 'macromixer-reminder',
                    requireInteraction: false,
                    silent: false
                });
            } catch (error) {
                console.error('Erro ao mostrar notifica√ß√£o:', error);
            }
        }

        function checkMealReminders() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // Verifica se j√° comeu hoje
            const hasEatenToday = dailyLog.items.length > 0;
            const lastMealTime = hasEatenToday ? new Date(dailyLog.items[dailyLog.items.length - 1].timestamp) : null;
            const hoursSinceLastMeal = lastMealTime ? (now - lastMealTime) / (1000 * 60 * 60) : 999;
            
            // Notifica√ß√£o de caf√© da manh√£
            if (notificationSettings.breakfast.enabled && currentTime === notificationSettings.breakfast.time) {
                if (!hasEatenToday || hoursSinceLastMeal > 3) {
                    showNotification('‚òï Hora do Caf√© da Manh√£!', 'N√£o esque√ßa de registrar sua primeira refei√ß√£o do dia.');
                }
            }
            
            // Notifica√ß√£o de almo√ßo
            if (notificationSettings.lunch.enabled && currentTime === notificationSettings.lunch.time) {
                if (hoursSinceLastMeal > 3) {
                    showNotification('üçΩÔ∏è Hora do Almo√ßo!', 'J√° passou da hora de comer. Registre sua refei√ß√£o!');
                }
            }
            
            // Notifica√ß√£o de jantar
            if (notificationSettings.dinner.enabled && currentTime === notificationSettings.dinner.time) {
                if (hoursSinceLastMeal > 4) {
                    showNotification('üåô Hora do Jantar!', '√öltima refei√ß√£o do dia. N√£o esque√ßa de registrar!');
                }
            }
            
            // Notifica√ß√£o inteligente de √°gua
            if (dailyLog.water < waterGoal && now.getHours() >= 10 && now.getHours() <= 20) {
                const waterPercent = (dailyLog.water / waterGoal) * 100;
                if (waterPercent < 50 && now.getMinutes() === 0) { // A cada hora cheia
                    showNotification('üíß Beba √Ågua!', `Voc√™ est√° em ${Math.round(waterPercent)}% da meta de √°gua.`);
                }
            }
        }

        function showNotificationBanner() {
            if (Notification.permission === 'default' && !localStorage.getItem('notification-dismissed')) {
                setTimeout(() => {
                    document.getElementById('notification-banner').classList.remove('hidden');
                }, 5000); // Mostra ap√≥s 5 segundos
            }
        }

        function enableNotifications() {
            requestNotificationPermission().then(granted => {
                if (granted) {
                    document.getElementById('notification-banner').classList.add('hidden');
                    showNotification('üéâ Notifica√ß√µes Ativadas!', 'Voc√™ receber√° lembretes para suas refei√ß√µes.');
                }
            });
        }

        function dismissNotificationBanner() {
            document.getElementById('notification-banner').classList.add('hidden');
            localStorage.setItem('notification-dismissed', 'true');
        }

        // --- GALLERY FUNCTIONS ---
        function openGallery() {
            const galleryGrid = document.getElementById('gallery-grid');
            const allPhotos = [];
            
            // Coleta todas as fotos das refei√ß√µes
            dailyLog.items.forEach((item, index) => {
                if (item.photo) {
                    allPhotos.push({
                        url: item.photo,
                        meal: item.name,
                        timestamp: item.timestamp,
                        index: index
                    });
                }
            });
            
            if (allPhotos.length === 0) {
                galleryGrid.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-8 col-span-full">
                        <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma foto ainda
                    </div>
                `;
            } else {
                galleryGrid.innerHTML = allPhotos.map(photo => `
                    <div class="relative group">
                        <img src="${photo.url}" alt="${photo.meal}" class="w-full h-32 object-cover rounded-lg border-2 border-slate-700 cursor-pointer" onclick="window.open('${photo.url}', '_blank')">
                        <button 
                            class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition-all shadow-lg z-10"
                            onclick="event.stopPropagation(); deletePhotoFromGallery(${photo.index}, '${photo.url}')"
                            title="Deletar foto"
                        >
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center pointer-events-none">
                            <i class="fa-solid fa-expand text-white text-2xl"></i>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2 rounded-b-lg pointer-events-none">
                            <div class="text-xs text-white font-bold truncate">${photo.meal}</div>
                            <div class="text-xs text-gray-300">${new Date(photo.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('gallery-modal').classList.remove('hidden');
        }

        function closeGallery() {
            document.getElementById('gallery-modal').classList.add('hidden');
        }

        async function deletePhotoFromGallery(mealIndex, photoURL) {
            if (!confirm('üóëÔ∏è Deletar esta foto? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            
            try {
                // Remove a foto do Firebase Storage (se for URL do Firebase)
                if (photoURL && photoURL.includes('firebasestorage.googleapis.com')) {
                    try {
                        const photoRef = ref(storage, photoURL);
                        await deleteObject(photoRef);
                        console.log('‚úÖ Foto deletada do Firebase Storage');
                    } catch (storageError) {
                        console.warn('‚ö†Ô∏è Erro ao deletar do Storage (pode j√° ter sido deletada):', storageError);
                    }
                }
                
                // Remove a foto da refei√ß√£o
                if (dailyLog.items[mealIndex]) {
                    dailyLog.items[mealIndex].photo = null;
                }
                
                // Salva no Firebase/localStorage
                await saveDailyLogToDB();
                
                // Atualiza a UI
                renderLogs();
                openGallery(); // Recarrega a galeria
                
                alert('‚úÖ Foto deletada com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao deletar foto:', error);
                alert('‚ö†Ô∏è Erro ao deletar foto. Tente novamente.');
            }
        }

        function updateGalleryPreview() {
            const galleryPreview = document.getElementById('gallery-preview');
            const recentPhotos = dailyLog.items
                .filter(item => item.photo)
                .slice(-4)
                .reverse();
            
            if (recentPhotos.length === 0) {
                galleryPreview.innerHTML = `
                    <div class="text-center text-slate-500 text-xs py-4 col-span-4">
                        <i class="fa-solid fa-info-circle mr-1"></i>Nenhuma foto ainda
                    </div>
                `;
            } else {
                galleryPreview.innerHTML = recentPhotos.map(item => `
                    <div class="relative group cursor-pointer" onclick="window.open('${item.photo}', '_blank')">
                        <img src="${item.photo}" alt="${item.name}" class="w-full h-20 object-cover rounded-lg border-2 border-slate-700 group-hover:border-pink-500 transition-all">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-expand text-white text-lg"></i>
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- REPORT GENERATION ---
        async function exportAsImage() {
            const historySection = document.getElementById('history-section');
            
            if (historySection.classList.contains('hidden')) {
                alert('‚ö†Ô∏è Abra o hist√≥rico semanal primeiro!');
                return;
            }
            
            try {
                const canvas = await html2canvas(historySection, {
                    backgroundColor: '#0f172a',
                    scale: 2,
                    logging: false
                });
                
                const link = document.createElement('a');
                link.download = `macromixer_report_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                alert('‚úÖ Imagem salva com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar imagem:', error);
                alert('‚ùå Erro ao gerar imagem. Tente novamente.');
            }
        }

        async function exportAsPDF() {
            const historySection = document.getElementById('history-section');
            
            if (historySection.classList.contains('hidden')) {
                alert('‚ö†Ô∏è Abra o hist√≥rico semanal primeiro!');
                return;
            }
            
            try {
                const canvas = await html2canvas(historySection, {
                    backgroundColor: '#0f172a',
                    scale: 2,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`macromixer_report_${new Date().toISOString().split('T')[0]}.pdf`);
                
                alert('‚úÖ PDF salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('‚ùå Erro ao gerar PDF. Tente novamente.');
            }
        }

        // --- DAY COMPARISON ---
        let comparisonDay = null;
        let comparisonChart = null;

        async function loadCompareDayOptions() {
            const select = document.getElementById('compare-day-select');
            const weekData = await loadWeeklyData();
            
            select.innerHTML = '<option value="">Selecione um dia...</option>';
            
            weekData.forEach(day => {
                if (day.total.cals > 0) {
                    const option = document.createElement('option');
                    option.value = day.date;
                    option.textContent = `${day.date} (${Math.round(day.total.cals)} kcal)`;
                    select.appendChild(option);
                }
            });
        }

        function toggleComparison() {
            const select = document.getElementById('compare-day-select');
            const selectedDate = select.value;
            
            if (!selectedDate) {
                alert('‚ö†Ô∏è Selecione um dia para comparar!');
                return;
            }
            
            if (comparisonDay === selectedDate) {
                // Remove comparison
                comparisonDay = null;
                renderWeeklyChart();
                document.getElementById('toggle-compare-btn').innerHTML = '<i class="fa-solid fa-chart-line mr-1"></i> Comparar';
            } else {
                // Add comparison
                comparisonDay = selectedDate;
                renderWeeklyChart();
                document.getElementById('toggle-compare-btn').innerHTML = '<i class="fa-solid fa-times mr-1"></i> Remover';
            }
        }

        // --- ACHIEVEMENTS SYSTEM ---
        const achievements = [
            { id: 'first_meal', name: 'Primeira Refei√ß√£o', description: 'Registre sua primeira refei√ß√£o', icon: 'üçΩÔ∏è', condition: () => dailyLog.items.length >= 1 },
            { id: 'streak_3', name: '3 Dias Seguidos', description: 'Registre refei√ß√µes por 3 dias consecutivos', icon: 'üî•', condition: () => getStreak() >= 3 },
            { id: 'streak_7', name: 'Semana Completa', description: '7 dias de registro', icon: '‚≠ê', condition: () => getStreak() >= 7 },
            { id: 'streak_30', name: 'M√™s Completo', description: '30 dias de registro', icon: 'üëë', condition: () => getStreak() >= 30 },
            { id: 'protein_goal', name: 'Meta de Prote√≠na', description: 'Atinja sua meta de prote√≠na', icon: 'üí™', condition: () => dailyLog.total.prot >= userSettings.prot },
            { id: 'calorie_goal', name: 'Meta de Calorias', description: 'Atinja sua meta de calorias', icon: 'üéØ', condition: () => Math.abs(dailyLog.total.cals - userSettings.cals) <= 100 },
            { id: 'water_goal', name: 'Hidrata√ß√£o Completa', description: 'Beba 3L de √°gua', icon: 'üíß', condition: () => dailyLog.water >= 3000 },
            { id: 'photo_meal', name: 'Fot√≥grafo', description: 'Registre uma refei√ß√£o com foto', icon: 'üì∏', condition: () => dailyLog.items.some(item => item.photo) },
            { id: 'favorite_meal', name: 'Chef Favorito', description: 'Salve uma refei√ß√£o favorita', icon: '‚≠ê', condition: () => favoriteMeals.length >= 1 },
            { id: 'meals_5', name: '5 Refei√ß√µes', description: 'Registre 5 refei√ß√µes em um dia', icon: 'üç¥', condition: () => dailyLog.items.length >= 5 },
            { id: 'perfect_day', name: 'Dia Perfeito', description: 'Atinja todas as metas em um dia', icon: '‚ú®', condition: () => {
                return dailyLog.total.prot >= userSettings.prot &&
                       dailyLog.total.carb >= userSettings.carb &&
                       dailyLog.total.fat >= userSettings.fat &&
                       Math.abs(dailyLog.total.cals - userSettings.cals) <= 100 &&
                       dailyLog.water >= 3000;
            }},
            { id: 'early_bird', name: 'Madrugador', description: 'Registre caf√© antes das 8h', icon: 'üåÖ', condition: () => {
                return dailyLog.items.some(item => {
                    const hour = new Date(item.timestamp).getHours();
                    return hour < 8;
                });
            }}
        ];

        let unlockedAchievements = [];

        function loadAchievements() {
            const saved = localStorage.getItem('achievements');
            unlockedAchievements = saved ? JSON.parse(saved) : [];
        }

        function saveAchievements() {
            localStorage.setItem('achievements', JSON.stringify(unlockedAchievements));
        }

        function checkAchievements() {
            let newUnlocks = [];
            
            achievements.forEach(achievement => {
                if (!unlockedAchievements.includes(achievement.id) && achievement.condition()) {
                    unlockedAchievements.push(achievement.id);
                    newUnlocks.push(achievement);
                }
            });
            
            if (newUnlocks.length > 0) {
                saveAchievements();
                newUnlocks.forEach(achievement => {
                    showAchievementNotification(achievement);
                });
            }
            
            renderAchievements();
        }

        function renderAchievements() {
            const container = document.getElementById('achievements-container');
            const count = document.getElementById('achievement-count');
            
            count.textContent = `${unlockedAchievements.length}/${achievements.length}`;
            
            container.innerHTML = achievements.map(achievement => {
                const unlocked = unlockedAchievements.includes(achievement.id);
                return `
                    <div class="text-center p-3 rounded-lg ${unlocked ? 'bg-yellow-900/30 border-2 border-yellow-500' : 'bg-slate-800/50 border-2 border-slate-700 opacity-50'} transition-all">
                        <div class="text-3xl mb-1">${achievement.icon}</div>
                        <div class="text-xs font-bold text-white truncate">${achievement.name}</div>
                        <div class="text-[10px] text-gray-400 truncate">${achievement.description}</div>
                        ${unlocked ? '<div class="text-[10px] text-yellow-400 mt-1">‚úì Conquistado</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function showAchievementNotification(achievement) {
            // Notifica√ß√£o visual
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-yellow-600 to-orange-600 text-white p-4 rounded-lg shadow-2xl z-50 animate-bounce';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-4xl">${achievement.icon}</div>
                    <div>
                        <div class="font-bold">üéâ Nova Conquista!</div>
                        <div class="text-sm">${achievement.name}</div>
                        <div class="text-xs opacity-80">${achievement.description}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
            
            // Notifica√ß√£o do navegador
            if (notificationPermission === 'granted') {
                showNotification(`üéâ Nova Conquista: ${achievement.name}`, achievement.description, achievement.icon);
            }
        }

        function getStreak() {
            // Calcula quantos dias consecutivos o usu√°rio registrou refei√ß√µes
            let streak = 0;
            let currentDate = new Date();
            
            for (let i = 0; i < 365; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const log = loadFromLocalStorage('log_' + dateStr);
                
                if (log && log.items && log.items.length > 0) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // --- AUTOCOMPLETE FUNCTIONS ---
        let autocompleteTimeout = null;
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;

        function getLastWord(text) {
            const lines = text.split('\n');
            const lastLine = lines[lines.length - 1];
            const words = lastLine.trim().split(/\s+/);
            return words[words.length - 1].toLowerCase();
        }

        function searchFoods(query) {
            if (!query || query.length < 2) return [];
            
            const results = [];
            const queryLower = query.toLowerCase();
            
            for (const [key, value] of Object.entries(foodDatabase)) {
                if (key.includes(queryLower)) {
                    results.push({
                        key: key,
                        name: value.unit,
                        macros: `P:${value.p}g C:${value.c}g G:${value.f}g ${value.kcal}kcal`
                    });
                }
                if (results.length >= 10) break; // Limita a 10 resultados
            }
            
            return results;
        }

        function showAutocomplete(suggestions) {
            const dropdown = document.getElementById('autocomplete-dropdown');
            
            if (suggestions.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            currentSuggestions = suggestions;
            selectedSuggestionIndex = -1;
            
            dropdown.innerHTML = suggestions.map((item, index) => `
                <div class="autocomplete-item p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-b-0 ${index === selectedSuggestionIndex ? 'bg-slate-700' : ''}" data-index="${index}">
                    <div class="font-bold text-white text-sm">${item.name}</div>
                    <div class="text-xs text-gray-400 font-mono">${item.macros}</div>
                </div>
            `).join('');
            
            dropdown.classList.remove('hidden');
            
            // Add click listeners
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'));
                    selectSuggestion(index);
                });
            });
        }

        function selectSuggestion(index) {
            if (index < 0 || index >= currentSuggestions.length) return;
            
            const suggestion = currentSuggestions[index];
            const textarea = document.getElementById('meal-input');
            const text = textarea.value;
            const lines = text.split('\n');
            const lastLine = lines[lines.length - 1];
            const words = lastLine.trim().split(/\s+/);
            
            // Remove a √∫ltima palavra (parcial) e adiciona a sugest√£o
            words.pop();
            words.push(suggestion.key);
            lines[lines.length - 1] = words.join(' ');
            
            textarea.value = lines.join('\n');
            textarea.focus();
            
            hideAutocomplete();
        }

        function hideAutocomplete() {
            document.getElementById('autocomplete-dropdown').classList.add('hidden');
            currentSuggestions = [];
            selectedSuggestionIndex = -1;
        }

        function handleAutocompleteInput(e) {
            clearTimeout(autocompleteTimeout);
            
            const lastWord = getLastWord(e.target.value);
            
            if (lastWord.length < 2) {
                hideAutocomplete();
                return;
            }
            
            autocompleteTimeout = setTimeout(() => {
                const suggestions = searchFoods(lastWord);
                showAutocomplete(suggestions);
            }, 300); // Debounce de 300ms
        }

        function handleAutocompleteKeydown(e) {
            const dropdown = document.getElementById('autocomplete-dropdown');
            
            if (dropdown.classList.contains('hidden')) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                showAutocomplete(currentSuggestions);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                showAutocomplete(currentSuggestions);
            } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                e.preventDefault();
                selectSuggestion(selectedSuggestionIndex);
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        }

        // --- EVENT LISTENERS ---
        console.log('üìå Registrando event listeners...');
        
        document.getElementById('goals-form').addEventListener('submit', saveUserSettings);
        document.getElementById('edit-goals-btn').addEventListener('click', () => document.getElementById('goals-section').classList.remove('hidden'));
        document.getElementById('close-goals-btn').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('goals-section').classList.add('hidden'); });
        
        // Clear Cache Button
        document.getElementById('clear-cache-btn').addEventListener('click', async () => {
            if (!confirm('‚ö†Ô∏è Isso vai limpar todo o cache e recarregar o app. Seus dados salvos N√ÉO ser√£o perdidos. Continuar?')) return;
            
            try {
                // Clear all caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    console.log('‚úÖ Cache limpo:', cacheNames);
                }
                
                // Unregister all service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    console.log('‚úÖ Service Workers removidos:', registrations.length);
                }
                
                // Clear session storage
                sessionStorage.clear();
                console.log('‚úÖ Session Storage limpo');
                
                alert('‚úÖ Cache limpo com sucesso! O app ser√° recarregado.');
                
                // Force reload from server
                window.location.reload(true);
            } catch (error) {
                console.error('‚ùå Erro ao limpar cache:', error);
                alert('‚ùå Erro ao limpar cache. Tente fechar e reabrir o app.');
            }
        });
        document.getElementById('btn-calculate').addEventListener('click', handleCalculate);
        document.getElementById('close-modal').addEventListener('click', () => document.getElementById('modal-result').classList.add('hidden'));
        document.getElementById('confirm-meal').addEventListener('click', pushMealToDB);
        document.getElementById('reset-day-btn').addEventListener('click', resetDay);
        document.getElementById('reset-water-btn').addEventListener('click', resetWater);
        document.getElementById('water-btn-100').addEventListener('click', () => addWater(100));
        document.getElementById('water-btn-250').addEventListener('click', () => addWater(250));
        document.getElementById('water-btn-500').addEventListener('click', () => addWater(500));
        document.getElementById('water-btn-1000').addEventListener('click', () => addWater(1000));
        document.getElementById('edit-water-goal-btn').addEventListener('click', editWaterGoal);
        document.getElementById('copy-yesterday-btn').addEventListener('click', copyYesterday);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('add-favorite-btn').addEventListener('click', saveFavoriteMeal);
        document.getElementById('open-gallery-btn').addEventListener('click', openGallery);
        document.getElementById('close-gallery-btn').addEventListener('click', closeGallery);
        document.getElementById('meal-photo-input').addEventListener('change', handlePhotoSelect);
        document.getElementById('meal-camera-input').addEventListener('change', handlePhotoSelect);
        document.getElementById('remove-photo-btn').addEventListener('click', removePhoto);
        document.getElementById('share-day-btn').addEventListener('click', openShareModal);
        document.getElementById('close-share-modal').addEventListener('click', closeShareModal);
        document.getElementById('share-whatsapp').addEventListener('click', shareToWhatsApp);
        document.getElementById('share-copy').addEventListener('click', copyShareText);
        document.getElementById('enable-notifications').addEventListener('click', enableNotifications);
        document.getElementById('dismiss-notifications').addEventListener('click', dismissNotificationBanner);
        
        // Autocomplete listeners
        const mealInput = document.getElementById('meal-input');
        mealInput.addEventListener('input', handleAutocompleteInput);
        mealInput.addEventListener('keydown', handleAutocompleteKeydown);
        mealInput.addEventListener('blur', () => {
            // Delay para permitir clique nas sugest√µes
            setTimeout(hideAutocomplete, 200);
        });
        
        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        
        if (btnLogin) {
            console.log('‚úÖ Bot√£o login encontrado, adicionando listener');
            btnLogin.addEventListener('click', handleLogin);
        } else {
            console.error('‚ùå Bot√£o login N√ÉO encontrado!');
        }
        
        if (btnLogout) {
            console.log('‚úÖ Bot√£o logout encontrado, adicionando listener');
            btnLogout.addEventListener('click', handleLogout);
        } else {
            console.log('‚ö†Ô∏è Bot√£o logout n√£o encontrado (normal se n√£o estiver logado)');
        }
        
        console.log('‚úÖ Event listeners registrados!');
        
        // AGORA configura onAuthStateChanged (DEPOIS dos event listeners)
        onAuthStateChanged(auth, (user) => {
            console.log('üîÑ onAuthStateChanged disparado (modo opcional)');
            console.log('User:', user);
            
            if (user) {
                console.log('‚úÖ Usu√°rio logado (Firebase ativo):', user.displayName || user.email);
                console.log('UID:', user.uid);
                currentUser = user;
                useLocalStorage = false;
                isLoggingIn = false;
                
                // Atualiza UI
                const btnLogin = document.getElementById('btn-login');
                const userStatus = document.getElementById('user-status');
                const usernameDisplay = document.getElementById('username-display');
                
                if (btnLogin) btnLogin.classList.add('hidden');
                if (userStatus) {
                    userStatus.classList.remove('hidden');
                    userStatus.classList.add('flex');
                }
                if (usernameDisplay) {
                    usernameDisplay.innerText = user.displayName || user.email || 'Usu√°rio';
                }
                
                console.log('üîÑ Sincronizando com Firebase (opcional)...');
                
                // Sincroniza com Firebase (mas n√£o bloqueia se falhar)
                try {
                    loadUserSettings();
                    loadDailyLog();
                    loadNotificationSettings();
                    loadAchievements();
                    renderAchievements();
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao sincronizar com Firebase (continuando offline):', error);
                }
            } else {
                console.log('‚ÑπÔ∏è Modo offline (sem Firebase)');
                currentUser = null;
                useLocalStorage = true;
                isLoggingIn = false;
                
                // Atualiza UI
                const btnLogin = document.getElementById('btn-login');
                const userStatus = document.getElementById('user-status');
                
                if (btnLogin) {
                    btnLogin.classList.remove('hidden');
                    btnLogin.classList.add('flex');
                }
                if (userStatus) {
                    userStatus.classList.add('hidden');
                    userStatus.classList.remove('flex');
                }
                
                // Dados j√° foram carregados do localStorage no in√≠cio
                console.log('‚úÖ App funcionando 100% offline');
            }
        });
        
        // New event listeners
        document.getElementById('prev-day-btn').addEventListener('click', () => changeViewDate(-1));
        document.getElementById('next-day-btn').addEventListener('click', () => changeViewDate(1));
        document.getElementById('view-history-btn').addEventListener('click', () => {
            document.getElementById('history-section').classList.remove('hidden');
            renderWeeklyChart();
            loadCompareDayOptions();
        });
        document.getElementById('close-history-btn').addEventListener('click', () => {
            document.getElementById('history-section').classList.add('hidden');
        });
        document.getElementById('toggle-notifications-btn').addEventListener('click', () => {
            const settings = document.getElementById('notification-settings');
            settings.classList.toggle('hidden');
            if (!settings.classList.contains('hidden')) {
                requestNotificationPermission();
            }
        });
        document.getElementById('save-notifications-btn').addEventListener('click', saveNotificationSettings);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
        document.getElementById('export-json-btn').addEventListener('click', exportToJSON);
        document.getElementById('export-image-btn').addEventListener('click', exportAsImage);
        document.getElementById('export-pdf-btn').addEventListener('click', exportAsPDF);
        document.getElementById('toggle-compare-btn').addEventListener('click', toggleComparison);
        document.getElementById('compare-day-select').addEventListener('change', () => {
            if (comparisonDay) {
                comparisonDay = null;
                document.getElementById('toggle-compare-btn').innerHTML = '<i class="fa-solid fa-chart-line mr-1"></i> Comparar';
            }
        });
        
        // Initialize
        console.log('üöÄ === INICIALIZANDO APP v3.4.1 ===');
        loadTheme();
        updateDateDisplay();
        loadNotificationSettings();
        startNotificationScheduler();
        loadWeightHistory();
        loadFavoriteMeals();
        loadAchievements();
        renderAchievements();
        showNotificationBanner();
        
        // CARREGA DADOS DO LOCALSTORAGE (agora que todas as fun√ß√µes est√£o definidas)
        console.log('üì¶ Carregando dados do localStorage...');
        loadUserSettingsLocal();
        loadDailyLogLocal();
        updateDashboard();
        renderLogs();
        updateWaterDisplay();
        console.log('‚úÖ Dados do localStorage carregados!');
        
        // Check notifications every minute
        setInterval(checkMealReminders, 60000);
        
        initAuth();
        
        // Register Service Worker (PWA) with forced update
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                    
                    // Force update on page load
                    registration.update();
                    
                    // Check for updates every 30 seconds
                    setInterval(() => {
                        registration.update();
                    }, 30000);
                    
                    // Listen for new service worker
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                console.log('üîÑ Nova vers√£o dispon√≠vel! Recarregando...');
                                window.location.reload();
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error('‚ùå Erro ao registrar Service Worker:', error);
                });
        }
        
        console.log('‚úÖ === APP TOTALMENTE INICIALIZADO ===');

    </script>
</body>
</html>
